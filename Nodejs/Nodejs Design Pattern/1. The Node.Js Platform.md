```table-of-contents
```

# *Kh√°i ni·ªám c·ªët l√µi*

## *Module*

### 1. Modules ‚Äì C·∫•u tr√∫c c∆° b·∫£n trong Node.js

* Trong Nodejs, ***module*** l√† ƒë∆°n v·ªã c∆° b·∫£n ƒë·ªÉ t·ªï ch·ª©c m√£ ngu·ªìn
* M·ªôt ch∆∞∆°ng tr√¨nh ƒë∆∞·ª£c chia nh·ªè th√†nh nhi·ªÅu module, m·ªói module ƒë·∫£m nhi·ªám m·ªôt ch·ª©c nƒÉng ri√™ng bi·ªát
‚û°Ô∏è ·ª®ng d·ª•ng d·ªÖ ph√°t tri·ªÉn, m·ªü r·ªông v√† t√°i s·ª≠ d·ª•ng

### 2. Tri·∫øt l√Ω: Modules nh·ªè, ph·∫°m vi h·∫πp

* Module n√™n ***nh·ªè*** kh√¥ng ch·ªâ v√¨ s·ªë d√≤ng code, m√† ***quan tr·ªçng h∆°n l√† v·ªÅ ph·∫°m vi ch·ª©c nƒÉng.***
* M·ªôt module l√Ω t∆∞·ªüng ch·ªâ ***n√™n l√†m m·ªôt vi·ªác***.

***npm*** v√† ***yarn*** l√† c√°c c√¥ng c·ª• qu·∫£n l√Ω module.
- Tr∆∞·ªõc ƒë√¢y, vi·ªác nhi·ªÅu package ph·ª• thu·ªôc v√†o c√°c phi√™n b·∫£n kh√°c nhau c·ªßa c√πng m·ªôt th∆∞ vi·ªán th∆∞·ªùng g√¢y xung ƒë·ªôt (g·ªçi l√† **dependency hell**).
- Node.js gi·∫£i quy·∫øt v·∫•n ƒë·ªÅ n√†y b·∫±ng c√°ch cho ph√©p m·ªói package c√≥ th·ªÉ c√†i ri√™ng phi√™n b·∫£n m√† n√≥ c·∫ßn ‚áí D√πng h√†ng ch·ª•c th∆∞ vi·ªán nh·ªè m√† ko lo xung ƒë·ªôt phi√™n b·∫£n

---

# *Nodejs internal*

## I/O is slow

Vi·ªác truy xu·∫•t d·ªØ li·ªáu trong disk ho·∫∑c network t·ªën nhi·ªÅu th·ªùi gian h∆°n so v·ªõi truy xu·∫•t d·ªØ li·ªáu trong RAM. 
B·∫£n ch·∫•t vi·ªác x·ª≠ l√Ω I/O kh√¥ng t·ªën nhi·ªÅu CPU, nh∆∞ng do nhi·ªÅu process c√πng chia s·∫ª (ƒë·ªçc, ghi) khi·∫øn I/O c·∫ßn c√≥ th·ªùi gian ch·ªù ‚áí g√¢y ra ƒë·ªô tr·ªÖ ƒë√°ng k·ªÉ

Trong th·ªùi gian ch·ªù I/O, ch∆∞∆°ng tr√¨nh s·∫Ω b·ªã ch·∫∑n n·∫øu kh√¥ng c√≥ c∆° ch·∫ø b·∫•t ƒë·ªìng b·ªô ***non-blocking***

## Blocking I/O

Trong l·∫≠p tr√¨nh truy·ªÅn th·ªëng, khi m·ªôt function g·ª≠i m·ªôt I/O request, n√≥ s·∫Ω ***block lu·ªìng th·ª±c thi cho t·ªõi khi vi·ªác x·ª≠ l√Ω I/O ho√†n th√†nh***.

‚û°Ô∏è T·ªën nhi·ªÅu th·ªùi gian, ch∆∞∆°ng tr√¨nh kh√¥ng th·ªÉ handle nhi·ªÅu t√°c v·ª• trong m·ªôt thread.

üí°V√≠ d·ª•: n·∫øu m·ªôt webserver ƒë∆∞·ª£c implement s·ª≠ d·ª•ng blocking I/O s·∫Ω kh√¥ng th·ªÉ handle ƒë∆∞·ª£c multiple connections tr√™n c√πng m·ªôt thread. ***I/O operation tr√™n m·ªôt socket s·∫Ω block vi·ªác x·ª≠ l√Ω c√°c connection kh√°c*** ‚û°Ô∏è s·ª≠u d·ª•ng nhi·ªÅu thread ho·∫∑c process ƒë·ªÉ c√≥ th·ªÉ handle dc nhi·ªÅu connection.

![[Pasted image 20250514233639.png]]

## Non-blocking I/O

Tri·∫øt l√Ω c·ªßa m√¥ h√¨nh n√†y l√† h·ªá th·ªëng s·∫Ω ***lu√¥n lu√¥n return ngay l·∫≠p t·ª©c m√† kh√¥ng ch·ªù d·ªØ li·ªáu ƒë∆∞·ª£c ƒë·ªçc ho·∫∑c ghi***.
N·∫øu t·∫°i th·ªùi ƒëi·ªÉm return m√† ch∆∞a c√≥ d·ªØ li·ªáu, h·ªá th·ªëng s·∫Ω tr·∫£ v·ªÅ m·ªôt ***predefined constant***.

## Event demultiplexing

### **1. Busy-waiting l√† g√¨ v√† t·∫°i sao kh√¥ng hi·ªáu qu·∫£?**
- **Busy-waiting** (ƒë·ª£i b·∫≠n r·ªôn) l√† m·ªôt k·ªπ thu·∫≠t trong ƒë√≥ ch∆∞∆°ng tr√¨nh **li√™n t·ª•c ki·ªÉm tra** (polling) m·ªôt t√†i nguy√™n (v√≠ d·ª•: xem m·ªôt socket ƒë√£ s·∫µn s√†ng ƒë·ªçc ch∆∞a) trong m·ªôt v√≤ng l·∫∑p.
- N√≥ **t·ªën CPU**, v√¨ ch∆∞∆°ng tr√¨nh kh√¥ng l√†m g√¨ ngo√†i vi·ªác l·∫∑p ƒëi l·∫∑p l·∫°i ƒë·ªÉ ch·ªù t√†i nguy√™n s·∫µn s√†ng.
- ƒê√¢y l√† m·ªôt c√°ch **thi·∫øu hi·ªáu qu·∫£**, nh·∫•t l√† khi b·∫°n c·∫ßn x·ª≠ l√Ω h√†ng trƒÉm ho·∫∑c h√†ng ngh√¨n k·∫øt n·ªëi m·∫°ng ho·∫∑c file c√πng l√∫c.
### **2. Synchronous Event Demultiplexer l√† g√¨?**

- C√°c h·ªá ƒëi·ªÅu h√†nh hi·ªán ƒë·∫°i nh∆∞ Linux, macOS, Windows cung c·∫•p m·ªôt c∆° ch·∫ø g·ªçi l√† **synchronous event demultiplexer** (giao di·ªán th√¥ng b√°o s·ª± ki·ªán ƒë·ªìng b·ªô).
- V√≠ d·ª• trong t·ª´ng h·ªá ƒëi·ªÅu h√†nh:
    - Linux: `epoll`
    - macOS/BSD: `kqueue`
    - Windows: `IOCP`
    - Unix chung: `select` ho·∫∑c `poll`

### **3. ∆Øu ƒëi·ªÉm c·ªßa synchronous event demultiplexer**

- ƒêi·ªÉm m·∫°nh: thay v√¨ **Busy-waiting** li√™n t·ª•c, ta g·ªçi h√†m (nh∆∞ `select`, `epoll_wait`,...) v√† **h·ªá ƒëi·ªÅu h√†nh s·∫Ω ch·∫∑n (block) lu·ªìng th·ª±c thi** cho ƒë·∫øn khi c√≥ **m·ªôt ho·∫∑c nhi·ªÅu s·ª± ki·ªán t·ª´ c√°c t√†i nguy√™n x·∫£y ra** (v√≠ d·ª•: socket c√≥ d·ªØ li·ªáu ƒë·ªÉ ƒë·ªçc).
- Khi c√≥ s·ª± ki·ªán, h√†m tr·∫£ v·ªÅ danh s√°ch t√†i nguy√™n s·∫µn s√†ng ‚áí ·ª©ng d·ª•ng ch·ªâ x·ª≠ l√Ω khi c·∫ßn thi·∫øt ‚áí **ti·∫øt ki·ªám t√†i nguy√™n** v√† **hi·ªáu su·∫•t cao**.

### **C√°ch Nodejs s·ª≠ d·ª•ng libuv v·ªõi Synchronous Event Demultiplexer**

#### üîÅ T·ªïng quan: Vai tr√≤ c·ªßa `libuv` trong Node.js

Node.js kh√¥ng t·ª± m√¨nh tr·ª±c ti·∫øp t∆∞∆°ng t√°c v·ªõi `epoll`, `kqueue`, `IOCP`, v.v. ƒë·ªÉ s·ª≠ d·ª•ng **synchronous event demultiplexer** c·ªßa h·ªá ƒëi·ªÅu h√†nh.
Thay v√†o ƒë√≥, n√≥ s·ª≠ d·ª•ng m·ªôt th∆∞ vi·ªán C c√≥ t√™n l√† **libuv**, v·ªën ƒë∆∞·ª£c thi·∫øt k·∫ø ƒë·ªÉ:
- **Tr·ª´u t∆∞·ª£ng h√≥a c√°c h·ªá ƒëi·ªÅu h√†nh kh√°c nhau**
- **Qu·∫£n l√Ω event loop**
- **X·ª≠ l√Ω I/O b·∫•t ƒë·ªìng b·ªô** (file, socket, DNS, timer, signal...)

#### ‚öôÔ∏è C√°ch libuv s·ª≠ d·ª•ng Synchronous Event Demultiplexer

##### 1. **Libuv Event Loop**
`libuv` c√≥ m·ªôt **event loop** trung t√¢m, v·∫≠n h√†nh theo nhi·ªÅu **giai ƒëo·∫°n (phases)**, v√≠ d·ª•:
- `timers`
- `pending callbacks`
- `idle, prepare`
- `poll` (‚üµ ph·∫ßn d√πng synchronous event demultiplexer)
- `check`
- `close callbacks`
##### 2. **Poll Phase: n∆°i g·ªçi synchronous event demultiplexer**

Trong giai ƒëo·∫°n `poll`, libuv:
- S·ª≠ d·ª•ng h·ªá th·ªëng **epoll (Linux)**, **kqueue (macOS/BSD)**, **IOCP (Windows)** ho·∫∑c **select (fallback)** ƒë·ªÉ ch·ªù c√°c t√†i nguy√™n I/O tr·ªü n√™n "s·∫µn s√†ng".
- ƒê√¢y ch√≠nh l√† synchronous event demultiplexer.

‚ü∂ Trong giai ƒëo·∫°n n√†y, thread ch√≠nh c·ªßa Node.js s·∫Ω **block** ƒë·ª£i s·ª± ki·ªán I/O (ch·∫≥ng h·∫°n nh∆∞ d·ªØ li·ªáu ƒë·∫øn t·ª´ socket), sau ƒë√≥ **ti·∫øp t·ª•c x·ª≠ l√Ω c√°c callback t∆∞∆°ng ·ª©ng**.


#### üß† C√°ch ho·∫°t ƒë·ªông th·ª±c t·∫ø: v√≠ d·ª•


```js
const fs = require('fs');

fs.readFile('data.txt', (err, data) => {
  if (err) throw err;
  console.log(data.toString());
});

```

1. L·ªùi g·ªçi `fs.readFile` kh√¥ng th·ª±c hi·ªán ƒë·ªçc file ngay l·∫≠p t·ª©c trong thread ch√≠nh.
2. Node.js **·ªßy quy·ªÅn cho libuv** ƒë·ªÉ th·ª±c hi·ªán thao t√°c ƒë·ªçc file b·∫•t ƒë·ªìng b·ªô:
    - N·∫øu h·ªá ƒëi·ªÅu h√†nh **kh√¥ng h·ªó tr·ª£ I/O b·∫•t ƒë·ªìng b·ªô v·ªõi file**, libuv s·∫Ω **ƒë·∫©y sang m·ªôt thread trong thread pool** ƒë·ªÉ x·ª≠ l√Ω.
    - V·ªõi socket/network, libuv ƒëƒÉng k√Ω s·ª± ki·ªán v√†o `epoll` ho·∫∑c `kqueue` ƒë·ªÉ ƒë·ª£i d·ªØ li·ªáu ƒë·∫øn.
3. Libuv s·ª≠ d·ª•ng event loop ƒë·ªÉ:
    - Ch·ªù ƒë·∫øn khi `read` ho√†n th√†nh.
    - G·ªçi l·∫°i callback (`console.log(...)`) tr√™n **thread ch√≠nh c·ªßa Node.js**.

#### üß† M√¥ ph·ªèng c√°ch ho·∫°t ƒë·ªông c·ªßa **event loop s·ª≠ d·ª•ng synchronous event demultiplexer**

```js
watchedList.add(socketA, FOR_READ)        // (1)
watchedList.add(fileB, FOR_READ)

while (events = demultiplexer.watch(watchedList)) {   // (2)
  // event loop
  for (event of events) {                              // (3)
    data = event.resource.read()
    if (data === RESOURCE_CLOSED) {
      demultiplexer.unwatch(event.resource)
    } else {
      consumeData(data)
    }
  }
}
```

ü´° ***==Gi·∫£i th√≠ch chi ti·∫øt m·ªôt ch√∫t==***

```js
watchedList.add(socketA, FOR_READ)
watchedList.add(fileB, FOR_READ)
```
- `watchedList` l√† danh s√°ch t√†i nguy√™n b·∫°n mu·ªën theo d√µi ‚Äì gi·ªëng nh∆∞ b·∫°n n√≥i v·ªõi h·ªá ƒëi·ªÅu h√†nh:  
    ‚û§ ‚ÄúT√¥i mu·ªën bi·∫øt khi n√†o `socketA` v√† `fileB` **c√≥ th·ªÉ ƒë·ªçc ƒë∆∞·ª£c** (FOR_READ) m√† kh√¥ng b·ªã ch·∫∑n.‚Äù
- ƒê√¢y c√≥ th·ªÉ l√†:
    - M·ªôt socket k·∫øt n·ªëi ƒë·∫øn client
    - M·ªôt file b·∫°n ƒëang ƒë·ªçc
    - M·ªôt pipe, stdin, ho·∫∑c thi·∫øt b·ªã

```js
while (events = demultiplexer.watch(watchedList)) {
```
- `demultiplexer.watch(watchedList)`:
    - ƒê√¢y l√† l·ªùi g·ªçi ƒë·∫øn synchronous event demultiplexer nh∆∞ `select()`, `epoll_wait()`, ho·∫∑c `kqueue()`.
    - N√≥ **ch·∫∑n (block)** ch∆∞∆°ng tr√¨nh t·∫°i ƒë√¢y **cho ƒë·∫øn khi** c√≥ **√≠t nh·∫•t m·ªôt t√†i nguy√™n trong watchedList s·∫µn s√†ng ƒë·ªÉ ƒë·ªçc**.
- Khi c√≥ t√†i nguy√™n s·∫µn s√†ng:
    - H√†m `watch()` tr·∫£ v·ªÅ m·ªôt danh s√°ch `events`, m·ªói ph·∫ßn t·ª≠ t∆∞∆°ng ·ª©ng v·ªõi m·ªôt t√†i nguy√™n ƒë√£ s·∫µn s√†ng

```js
for (event of events) {
  data = event.resource.read()
```
- T·∫°i th·ªùi ƒëi·ªÉm n√†y, h·ªá ƒëi·ªÅu h√†nh **ƒë·∫£m b·∫£o r·∫±ng b·∫°n c√≥ th·ªÉ ƒë·ªçc t·ª´ t√†i nguy√™n n√†y m√† kh√¥ng b·ªã block**.
- `event.resource.read()` th·ª±c hi·ªán thao t√°c ƒë·ªçc, v√† **lu√¥n c√≥ d·ªØ li·ªáu ho·∫∑c k·∫øt qu·∫£ r√µ r√†ng**, kh√¥ng bao gi·ªù b·ªã "treo".

```js
if (data === RESOURCE_CLOSED) {
  demultiplexer.unwatch(event.resource)
} else {
  consumeData(data)
}
```
- N·∫øu t√†i nguy√™n (nh∆∞ socket) ƒë√£ b·ªã ƒë√≥ng:
    - G·ª° n√≥ kh·ªèi danh s√°ch theo d√µi b·∫±ng `unwatch(...)`
- N·∫øu c√≥ d·ªØ li·ªáu th·ª±c s·ª±:
    - G·ªçi h√†m x·ª≠ l√Ω nh∆∞ `consumeData(data)` ƒë·ªÉ x·ª≠ l√Ω n·ªôi dung.

üîÅ Quay l·∫°i v√≤ng l·∫∑p: ‚ÄúEvent Loop‚Äù
- Sau khi x·ª≠ l√Ω h·∫øt c√°c s·ª± ki·ªán hi·ªán t·∫°i, ch∆∞∆°ng tr√¨nh l·∫°i quay v·ªÅ d√≤ng v√† ti·∫øp t·ª•c **ch·ªù ƒë·ª£i t√†i nguy√™n m·ªõi s·∫µn s√†ng** ‚Üí ƒê√¢y ch√≠nh l√† **event loop**.
```js
demultiplexer.watch(watchedList)
```

‚ö†Ô∏è **==Ch√∫ √Ω:==** trong nodes, khi `watchedList` r·ªóng, **kh√¥ng c√≤n pending I/O ho·∫∑c callback n√†o trong event loop** ho·∫∑c h·ªá th·ªëng event-driven **nh∆∞ng kh√¥ng c√≤n socket/file n√†o ƒëang theo d√µi** (v√¨ ƒë√£ b·ªã `close` h·∫øt) th√¨ **Node.js s·∫Ω t·ª± ƒë·ªông tho√°t ch∆∞∆°ng tr√¨nh**.

![[Pasted image 20250516001757.png]]


---
## Reactor Pattern

**Reactor pattern** l√† m·ªôt m·∫´u thi·∫øt k·∫ø (design pattern) d√πng ƒë·ªÉ x·ª≠ l√Ω c√°c s·ª± ki·ªán **I/O b·∫•t ƒë·ªìng b·ªô** (asynchronous I/O), th∆∞·ªùng d√πng trong h·ªá th·ªëng y√™u c·∫ßu hi·ªáu nƒÉng cao v√† x·ª≠ l√Ω nhi·ªÅu k·∫øt n·ªëi c√πng l√∫c (nh∆∞ web server).

Thay v√¨ ƒë·ªÉ m·ªói k·∫øt n·ªëi/s·ª± ki·ªán I/O t·∫°o m·ªôt thread ri√™ng (g√¢y t·ªën b·ªô nh·ªõ), reactor pattern d√πng **m·ªôt v√≤ng l·∫∑p s·ª± ki·ªán (event loop)** ƒë·ªÉ l·∫Øng nghe c√°c s·ª± ki·ªán v√† khi s·ª± ki·ªán x·∫£y ra, n√≥ g·ªçi m·ªôt **h√†m x·ª≠ l√Ω (handler)** t∆∞∆°ng ·ª©ng.

Handler l√† ƒëo·∫°n m√£ ƒë∆∞·ª£c ƒë·ªãnh nghƒ©a ƒë·ªÉ x·ª≠ l√Ω m·ªôt s·ª± ki·ªán c·ª• th·ªÉ. Trong Node.js, handler n√†y ch√≠nh l√† m·ªôt **callback function** ‚Äî m·ªôt h√†m ƒë∆∞·ª£c truy·ªÅn v√†o v√† ƒë∆∞·ª£c g·ªçi khi s·ª± ki·ªán x·∫£y ra (v√≠ d·ª• khi ƒë·ªçc file xong, nh·∫≠n d·ªØ li·ªáu t·ª´ socket, v.v.).

- Node.js s·ª≠ d·ª•ng reactor pattern trong **event loop** c·ªßa n√≥.
- Khi c√≥ m·ªôt thao t√°c I/O (v√≠ d·ª• ƒë·ªçc file), Node.js **kh√¥ng ch·ªù** cho ƒë·∫øn khi ho√†n t·∫•t m√† ti·∫øp t·ª•c x·ª≠ l√Ω c√°c l·ªánh kh√°c.
- Khi I/O ho√†n t·∫•t, Node.js s·∫Ω **g·ªçi callback** m√† b·∫°n ƒë√£ cung c·∫•p t·ª´ tr∆∞·ªõc ƒë·ªÉ x·ª≠ l√Ω k·∫øt qu·∫£ ‚Üí ch√≠nh callback ƒë√≥ l√† **handler** g·∫Øn v·ªõi thao t√°c I/O.
![[Pasted image 20250516230315.png]]
**==Gi·∫£i th√≠ch chi ti·∫øt t·ª´ng b∆∞·ªõc==** 

#### **1. ·ª®ng d·ª•ng g·ª≠i y√™u c·∫ßu I/O b·∫•t ƒë·ªìng b·ªô cho Event Demultiplexer**

- Khi ·ª©ng d·ª•ng c·∫ßn th·ª±c hi·ªán m·ªôt thao t√°c I/O (nh∆∞ ƒë·ªçc file, nh·∫≠n d·ªØ li·ªáu t·ª´ socket...), n√≥ **g·ª≠i y√™u c·∫ßu ƒë·∫øn Event Demultiplexer**.
    
- ƒê·ªìng th·ªùi, ·ª©ng d·ª•ng **truy·ªÅn k√®m m·ªôt handler (callback function)** ƒë·ªÉ x·ª≠ l√Ω k·∫øt qu·∫£ khi thao t√°c n√†y ho√†n t·∫•t.
    
- Qu√° tr√¨nh n√†y l√† **non-blocking**, t·ª©c l√† ch∆∞∆°ng tr√¨nh **kh√¥ng ch·ªù ƒë·ª£i k·∫øt qu·∫£** m√† ti·∫øp t·ª•c th·ª±c hi·ªán c√°c vi·ªác kh√°c ngay l·∫≠p t·ª©c (m≈©i t√™n n√©t ƒë·ª©t tr·∫£ v·ªÅ).

#### **2. Khi c√°c thao t√°c I/O ho√†n th√†nh, Event Demultiplexer ƒë·∫©y c√°c s·ª± ki·ªán v√†o Event Queue**

- Event Demultiplexer (v√≠ d·ª•: `epoll`, `kqueue`, `IOCP`...) s·∫Ω l·∫Øng nghe t·∫•t c·∫£ c√°c thao t√°c I/O ƒëang ch·ªù.
    
- khi m·ªôt (ho·∫∑c nhi·ªÅu) thao t√°c I/O ƒë√£ ho√†n th√†nh (v√≠ d·ª•: c√≥ d·ªØ li·ªáu m·ªõi t·ª´ socket, file ƒë·ªçc xong, v.v...), n√≥ **t·∫°o ra m·ªôt s·ª± ki·ªán t∆∞∆°ng ·ª©ng** cho m·ªói thao t√°c ƒë√≥ (v√≠ d·ª•: `"data ready on socket A"`), k√®m **th√¥ng tin v·ªÅ handler** ƒë√£ ƒëƒÉng k√Ω tr∆∞·ªõc ƒë√≥ (callback function).

>üëâ **L∆∞u √Ω:** Event Demultiplexer **kh√¥ng ƒë·∫©y d·ªØ li·ªáu (data) tr·ª±c ti·∫øp**, m√† ƒë·∫©y **th√¥ng tin s·ª± ki·ªán I/O ƒë√£ ho√†n th√†nh**, ƒë·ªÉ sau ƒë√≥ callback (handler) c·ªßa b·∫°n s·∫Ω **t·ª± ƒë·ªçc data khi ƒë∆∞·ª£c g·ªçi**.

#### **3. Event Loop b·∫Øt ƒë·∫ßu l·∫∑p qua c√°c s·ª± ki·ªán trong Event Queue**

- Event Loop l√† m·ªôt v√≤ng l·∫∑p ch√≠nh trong ch∆∞∆°ng tr√¨nh (nh∆∞ c·ªßa Node.js).
- N√≥ **l·∫•y t·ª´ng s·ª± ki·ªán ra kh·ªèi Event Queue**, x·ª≠ l√Ω l·∫ßn l∆∞·ª£t.

#### **4. V·ªõi m·ªói s·ª± ki·ªán, h√†m handler t∆∞∆°ng ·ª©ng ƒë∆∞·ª£c g·ªçi**

- ·ª®ng d·ª•ng ƒë√£ ƒëƒÉng k√Ω handler t·ª´ b∆∞·ªõc (1), gi·ªù handler n√†y ƒë∆∞·ª£c g·ªçi ƒë·ªÉ x·ª≠ l√Ω k·∫øt qu·∫£ I/O.
    
- V√≠ d·ª•: h√†m callback `console.log(data)` ƒë∆∞·ª£c g·ªçi sau khi file ƒë·ªçc xong.

#### **5. Khi handler ho√†n t·∫•t, n√≥ tr·∫£ quy·ªÅn ƒëi·ªÅu khi·ªÉn l·∫°i cho Event Loop**

- Handler th·ª±c thi xong th√¨ **Event Loop ti·∫øp t·ª•c x·ª≠ l√Ω c√°c s·ª± ki·ªán kh√°c** trong queue.
    
- **5a.** Khi m·ªôt handler k·∫øt th√∫c, control quay v·ªÅ Event Loop.
    
- **5b.** Trong qu√° tr√¨nh ch·∫°y, handler **c√≥ th·ªÉ ƒëƒÉng k√Ω th√™m c√°c thao t√°c I/O m·ªõi** ‚Üí quay l·∫°i b∆∞·ªõc (1).
#### **6. Khi Event Queue tr·ªëng, Event Loop l·∫°i ch·ªù ·ªü Event Demultiplexer**

- N·∫øu kh√¥ng c√≤n s·ª± ki·ªán n√†o trong Event Queue, Event Loop **t·∫°m ng·ª´ng (blocks)** v√† **ch·ªù Event Demultiplexer th√¥ng b√°o khi c√≥ s·ª± ki·ªán m·ªõi**.
    
- Khi c√≥ s·ª± ki·ªán m·ªõi, qu√° tr√¨nh l·∫°i **b·∫Øt ƒë·∫ßu l·∫°i t·ª´ b∆∞·ªõc 2**.

---

## Libuv, the I/O engine of Nodejs

M·ªói h·ªá ƒëi·ªÅu h√†nh s·∫Ω c√≥ interface ri√™ng c·ªßa n√≥ cho ***event demultiplexer***: `epoll` cho linux, `kqueue` cho macOS, v√† `I/O completion port (IOCP) API` cho window.

Tr√™n **c√πng h·ªá ƒëi·ªÅu h√†nh**, c√°c lo·∫°i t√†i nguy√™n kh√°c nhau c≈©ng s·∫Ω ƒë∆∞·ª£c x·ª≠ l√Ω theo c√°c c√°ch kh√°c nhau
* c√°c ***filesystem files*** th√¥ng th∆∞·ªùng ***kh√¥ng h·ªó tr·ª£ c√°c non-blocking operation*** ‚áí b·∫Øt bu·ªôc ph·∫£i t·∫°o ra nhi·ªÅu thread b√™n ngo√†i event loop ƒë·ªÉ gi·∫£i l·∫≠p non-blocking behavior

‚û°Ô∏è ***libuv*** ra ƒë·ªùi nh∆∞ m·ªôt ***higher-level abstraction*** ƒë·ªÉ event demultiplexer x·ª≠ l√Ω c√°c lo·∫°i resource kh√°c nhau.
***Libuv*** l√† ***low-level I/O engine*** c·ªßa Node.js, l√† component quan tr·ªçng nh·∫•t c·ªßa Nodejs.

***Libuv*** c≈©ng implement ***reactor pattern*** ‚Üî cung c·∫•p API ƒë·ªÉ t·∫°o event loops, qu·∫£n l√Ω event queue v√† ch·∫°y c√°c asynchronous I/O operations.


---

## Other component in Nodejs

Reactor pattern v√† libuv l√† c√°c th√†nh ph·∫ßn c∆° b·∫£n c·ªßa Nodejs, ngo√†i ra c√≤n c√≥ 3 component kh√°c

![[Pasted image 20250517101928.png]]

### **1. Bindings (Li√™n k·∫øt gi·ªØa C/C++ v√† JavaScript)**

- ƒê√¢y l√† **l·ªõp c·∫ßu n·ªëi (bindings)** gi·ªØa m√£ C/C++ c·∫•p th·∫•p (nh∆∞ libuv, file system, OS-level APIs) v√† m√£ JavaScript.
    
- C√°c bindings n√†y cho ph√©p Node.js g·ªçi c√°c h√†m c·ªßa libuv v√† c√°c h·ªá th·ªëng C/C++ kh√°c t·ª´ m√£ JavaScript.
    
- V√≠ d·ª•: khi b·∫°n g·ªçi `fs.readFile()` trong Node.js, th·∫≠t ra ph√≠a d∆∞·ªõi l√† m·ªôt binding g·ªçi ƒë·∫øn libuv, th·ª±c hi·ªán ƒë·ªçc file v√† sau ƒë√≥ tr·∫£ k·∫øt qu·∫£ v·ªÅ cho JavaScript.
    

‚û°Ô∏è **N√≥ l√† ph·∫ßn kh√¥ng th·ªÉ thi·∫øu gi√∫p JS c√≥ th·ªÉ ‚Äún√≥i chuy·ªán‚Äù v·ªõi h·ªá th·ªëng c·∫•p th·∫•p.**

### **2. V8 Engine**

- **V8** l√† **tr√¨nh th√¥ng d·ªãch v√† bi√™n d·ªãch Just-In-Time (JIT)** m√£ JavaScript ƒë∆∞·ª£c ph√°t tri·ªÉn b·ªüi Google (d√πng trong Chrome).
- N√≥ chuy·ªÉn m√£ JavaScript th√†nh m√£ m√°y r·∫•t nhanh v√† t·ªëi ∆∞u.
- V8 l√† l√Ω do Node.js ch·∫°y nhanh v√¨ n√≥ x·ª≠ l√Ω JS hi·ªáu qu·∫£ v√† c√≥ kh·∫£ nƒÉng qu·∫£n l√Ω b·ªô nh·ªõ t·ªët.

‚û°Ô∏è Node.js s·ª≠ d·ª•ng V8 ƒë·ªÉ th·ª±c thi t·∫•t c·∫£ m√£ JavaScript b·∫°n vi·∫øt.

### **3. Core JavaScript Library (Th∆∞ vi·ªán chu·∫©n c·ªßa Node.js)**

- ƒê√¢y l√† ph·∫ßn **cung c·∫•p c√°c API high-level** c·ªßa Node.js nh∆∞:
    - `http`, `fs`, `net`, `child_process`, `stream`, `crypto`,...
- Ph·∫ßn n√†y **vi·∫øt b·∫±ng JavaScript**, s·ª≠ d·ª•ng c√°c bindings ƒë·ªÉ g·ªçi t·ªõi c√°c t√≠nh nƒÉng h·ªá th·ªëng ph√≠a d∆∞·ªõi.

‚û°Ô∏è ƒê√¢y l√† ph·∫ßn gi√∫p b·∫°n c√≥ th·ªÉ d√πng c√°c module m·∫°nh m·∫Ω ch·ªâ b·∫±ng c√∫ ph√°p JavaScript quen thu·ªôc.

---

## The Module system

### ‚úÖ **1. CommonJS l√† g√¨?**

- **CommonJS** l√† **h·ªá th·ªëng module nguy√™n th·ªßy c·ªßa Node.js**.
- S·ª≠ d·ª•ng c√∫ ph√°p:
```js
const fs = require('fs');
const myModule = require('./myModule');
```
* **`require()`** d√πng ƒë·ªÉ **import** (n·∫°p) c√°c h√†m, bi·∫øn, class t·ª´ m·ªôt module kh√°c (c√≥ th·ªÉ l√† module d·ª±ng s·∫µn c·ªßa Node ho·∫∑c file `.js` tr√™n ·ªï ƒëƒ©a).
### üí° ∆Øu ƒëi·ªÉm:
- L√† c√°ch ƒë·∫ßu ti√™n gi√∫p **t·ªï ch·ª©c m√£ JavaScript theo ki·ªÉu module h√≥a**, r·∫•t c·∫ßn thi·∫øt ƒë·ªÉ x√¢y d·ª±ng ·ª©ng d·ª•ng l·ªõn.
- Gi√∫p Node.js s√°nh ngang v·ªõi c√°c n·ªÅn t·∫£ng server kh√°c nh∆∞ Java, Python, v.v.

### ‚úÖ **2. CommonJS ·∫£nh h∆∞·ªüng ƒë·∫øn c·∫£ ph√≠a client (tr√¨nh duy·ªát)**

- M·∫∑c d√π CommonJS ƒë∆∞·ª£c thi·∫øt k·∫ø cho Node.js (m√¥i tr∆∞·ªùng ph√≠a server), **n√≥ c≈©ng ƒë∆∞·ª£c s·ª≠ d·ª•ng ·ªü ph√≠a client** khi k·∫øt h·ª£p v·ªõi c√°c c√¥ng c·ª• nh∆∞:
    - **Webpack**
    - **Rollup**
- C√°c c√¥ng c·ª• n√†y cho ph√©p b·∫°n vi·∫øt code ki·ªÉu CommonJS (`require`, `module.exports`) r·ªìi **bundler s·∫Ω chuy·ªÉn ƒë·ªïi l·∫°i th√†nh m√£ JavaScript m√† tr√¨nh duy·ªát hi·ªÉu ƒë∆∞·ª£c**.

### ‚úÖ **3. S·ª± xu·∫•t hi·ªán c·ªßa ES Modules (ESM)**

- ES Modules (ESM) l√† **chu·∫©n module ch√≠nh th·ª©c** c·ªßa JavaScript t·ª´ ECMAScript 2015 (ES6).
- S·ª≠ d·ª•ng c√∫ ph√°p:
```js
import fs from 'fs';
import { something } from './myModule.js';
```
- ƒê√¢y l√† c√∫ ph√°p ƒë∆∞·ª£c s·ª≠ d·ª•ng trong **tr√¨nh duy·ªát hi·ªán ƒë·∫°i** v√† **c≈©ng ƒë∆∞·ª£c Node.js h·ªó tr·ª£**, nh∆∞ng c√≥ m·ªôt s·ªë kh√°c bi·ªát.
### ‚úÖ **4. S·ª± kh√°c nhau gi·ªØa ESM trong tr√¨nh duy·ªát v√† Node.js**

|M√¥i tr∆∞·ªùng|ƒê·∫∑c ƒëi·ªÉm|
|---|---|
|**Tr√¨nh duy·ªát**|ESM th∆∞·ªùng **import qua URL t·ª´ server**, v√≠ d·ª•: `import { x } from 'https://example.com/module.js'`|
|**Node.js**|ESM hi·ªán t·∫°i **ch·ªâ ho·∫°t ƒë·ªông v·ªõi c√°c module n·∫±m tr√™n ·ªï ƒëƒ©a (local filesystem)**. N√≥ kh√¥ng h·ªó tr·ª£ import qua URL t·ª´ internet (tr·ª´ khi c√≥ th√™m loader ho·∫∑c tool h·ªó tr·ª£).|

‚û°Ô∏è M·∫∑c d√π Node.js **h·ªó tr·ª£ c√∫ ph√°p ES Modules**, nh∆∞ng **c√°ch n√≥ x·ª≠ l√Ω kh√°c v·ªõi tr√¨nh duy·ªát**, v√¨ tr√¨nh duy·ªát h∆∞·ªõng t·ªõi m·∫°ng (web), c√≤n Node.js h∆∞·ªõng t·ªõi h·ªá th·ªëng file c·ª•c b·ªô.

### üß± V√≠ d·ª•: M·ªôt module `math.js` c√≥ h√†m c·ªông v√† tr·ª´

#### ‚úÖ CommonJS (s·ª≠ d·ª•ng `require`, `module.exports`)

 üìÑ `math.js`
```js
 function add(a, b) {
  return a + b;
}

function subtract(a, b) {
  return a - b;
}

// Xu·∫•t c√°c h√†m ra ngo√†i module
module.exports = {
  add,
  subtract
};

```

üìÑ `main.js`

```js
const math = require('./math'); // import module

console.log(math.add(2, 3));      // Output: 5
console.log(math.subtract(5, 2)); // Output: 3
```

#### ‚úÖ ES Modules (s·ª≠ d·ª•ng `import`, `export`)

> üìù **Ghi ch√∫:** N·∫øu ch·∫°y b·∫±ng Node.js, h√£y ƒë·∫£m b·∫£o file c√≥ ƒëu√¥i `.mjs`, ho·∫∑c file `.js` v√† b·∫°n ph·∫£i khai b√°o `"type": "module"` trong `package.json`. N·∫øu kh√¥ng khai b√°o g√¨, m·∫∑c ƒë·ªãnh c·ªßa nodejs s·∫Ω s·ª≠ d·ª•ng `"type": "commonjs"`

üìÑ `math.mjs` ho·∫∑c `math.js` (v·ªõi `"type": "module"`)
```js
export function add(a, b) {
  return a + b;
}

export function subtract(a, b) {
  return a - b;
}
```

üìÑ `main.mjs` ho·∫∑c `main.js`

```js
import { add, subtract } from './math.js'; // import module

console.log(add(2, 3));      // Output: 5
console.log(subtract(5, 2)); // Output: 3

```

---

## Running native code

### ‚úÖ 1. Userland modules c√≥ th·ªÉ bind (li√™n k·∫øt) v·ªõi native code (C/C++)

- Trong Node.js, b·∫°n c√≥ th·ªÉ vi·∫øt **module b·∫±ng JavaScript** nh∆∞ b√¨nh th∆∞·ªùng, **nh∆∞ng b·∫°n c≈©ng c√≥ th·ªÉ vi·∫øt module b·∫±ng C/C++** r·ªìi **g·∫Øn n√≥ (bind) v√†o Node.js**.
    
- Nh·ªØng module nh∆∞ v·∫≠y ƒë∆∞·ª£c g·ªçi l√† **native modules**.
    
- Node.js h·ªó tr·ª£ vi·ªác n√†y th√¥ng qua **N-API** ‚Äì m·ªôt giao di·ªán ch√≠nh th·ª©c ƒë·ªÉ t·∫°o c√°c module native m·ªôt c√°ch ·ªïn ƒë·ªãnh, kh√¥ng b·ªã ph·ª• thu·ªôc s√¢u v√†o phi√™n b·∫£n V8.

M·∫∑c d√π **V8 r·∫•t nhanh trong vi·ªác ch·∫°y JavaScript**, nh∆∞ng **v·∫´n ch·∫≠m h∆°n native code** (C/C++) trong c√°c t√°c v·ª• x·ª≠ l√Ω n·∫∑ng nh∆∞:
- T√≠nh to√°n s·ªë h·ªçc ph·ª©c t·∫°p
- X·ª≠ l√Ω d·ªØ li·ªáu l·ªõn (data processing)
- N√©n/gi·∫£i n√©n, m√£ h√≥a/gi·∫£i m√£, AI inference...