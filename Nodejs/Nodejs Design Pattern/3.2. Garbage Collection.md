Viá»‡c quáº£n lÃ½ bá»™ nhá»› (memory management) trong Javascript Ä‘Æ°á»£c thá»±c hiá»‡n má»™t cÃ¡ch hoÃ n toÃ n tá»± Ä‘á»™ng.

Báº¥t cá»© khi nÃ o ngÆ°á»i dÃ¹ng táº¡o cÃ¡c `primitives`, `objects`, `functions`,... thÃ¬ Ä‘á»u cáº§n cÃ³ memory.

## Reachability

Javascript quáº£n lÃ½ bá»™ nhá»› chá»§ yáº¿u dá»±a vÃ o `reachability`, tá»©c lÃ  ***má»™t giÃ¡ trá»‹ cÃ³ thá»ƒ truy cáº­p Ä‘Æ°á»£c***  tá»« má»™t pháº§n nÃ o Ä‘Ã³ cá»§a chÆ°Æ¡ng trÃ¬nh.

### âœ… **CÃ¡ch dá»… hiá»ƒu vá» quáº£n lÃ½ bá»™ nhá»› trong JavaScript:**
1. **Trong JavaScript, háº§u háº¿t má»i thá»© Ä‘á»u lÃ  object** (trá»« má»™t sá»‘ kiá»ƒu nguyÃªn thá»§y nhÆ° `number`, `string`, `boolean`,... nhÆ°ng ngay cáº£ chÃºng cÅ©ng Ä‘Æ°á»£c bao bá»Ÿi object khi cáº§n).

2. **Má»—i object sáº½ Ä‘Æ°á»£c lÆ°u á»Ÿ má»™t vÃ¹ng nhá»› riÃªng biá»‡t trong RAM.**
    
3. Khi báº¡n gÃ¡n object vÃ o má»™t biáº¿n, biáº¿n Ä‘Ã³ **chá»‰ giá»¯ má»™t tham chiáº¿u (reference)** Ä‘áº¿n vÃ¹ng nhá»› Ä‘Ã³, **chá»© khÃ´ng pháº£i lÃ  báº£n sao cá»§a object**.
    
4. Náº¿u má»™t object **váº«n cÃ²n Ä‘Æ°á»£c sá»­ dá»¥ng á»Ÿ Ä‘Ã¢u Ä‘Ã³ trong chÆ°Æ¡ng trÃ¬nh** (tá»©c lÃ  cÃ³ biáº¿n hoáº·c thuá»™c tÃ­nh nÃ o Ä‘Ã³ Ä‘ang tham chiáº¿u tá»›i nÃ³), thÃ¬:
    
    - VÃ¹ng nhá»› cá»§a object Ä‘Ã³ Ä‘Æ°á»£c gá»i lÃ  **"cÃ³ thá»ƒ truy cáº­p Ä‘Æ°á»£c" (reachable)**.
    - VÃ  vÃ¬ tháº¿, **JavaScript sáº½ khÃ´ng giáº£i phÃ³ng (xÃ³a) nÃ³ khá»i bá»™ nhá»›**.
        
5. Khi **khÃ´ng cÃ²n chá»— nÃ o trong chÆ°Æ¡ng trÃ¬nh tham chiáº¿u Ä‘áº¿n object ná»¯a**, thÃ¬:
    
    - NÃ³ trá»Ÿ thÃ nh **"khÃ´ng thá»ƒ truy cáº­p" (unreachable)**.
    - JavaScript engine sáº½ **tá»± Ä‘á»™ng xÃ³a vÃ¹ng nhá»› Ä‘Ã³** trong má»™t láº§n cháº¡y cá»§a **Garbage Collector**.
VÃ­ dá»¥

```js
let person = {
  name: "Alice"
};
```
- Biáº¿n `person` giá»¯ tham chiáº¿u tá»›i má»™t object `{ name: "Alice" }`.
- VÃ¬ váº«n cÃ³ biáº¿n `person` tham chiáº¿u â†’ object váº«n **reachable** â†’ khÃ´ng bá»‹ xÃ³a.

```js
person = null;
```
- BÃ¢y giá», khÃ´ng cÃ²n biáº¿n nÃ o giá»¯ tham chiáº¿u Ä‘áº¿n object ná»¯a.
- Object `{ name: "Alice" }` trá»Ÿ thÃ nh **unreachable** â†’ sáº½ bá»‹ **xÃ³a khá»i bá»™ nhá»› tá»± Ä‘á»™ng** sau má»™t thá»i gian.



Javascript Ä‘á»‹nh nghÄ©a má»™t ***táº­p há»£p cÃ¡c giÃ¡ trá»‹ luÃ´n luÃ´n reachable***, Ä‘Æ°á»£c gá»i lÃ  cÃ¡c `roots`, bao gá»“m:
* CÃ¡c function Ä‘ang Ä‘Æ°á»£c thá»±c thi (function hiá»‡n táº¡i), cÃ¡c biáº¿n cá»¥c bá»™ vÃ  tham sá»‘ cá»§a fuction Ä‘Ã³
* CÃ¡c hÃ m trong call stack (khi cÃ³ chuá»—i hÃ m gá»i láº«n nhau)
* CÃ¡c biáº¿n toÃ n cá»¥c ***global variables***
* Má»™t sá»‘ giÃ¡ trá»‹ ná»™i bá»™ khÃ¡c mÃ  Javascript engine quáº£n lÃ½.

â¡ï¸ CÃ¡c giÃ¡ trá»‹ `roots` máº·c Ä‘á»‹nh luÃ´n Ä‘Æ°á»£c giá»¯ trong bá»™ nhá»›.

CÃ¡c giÃ¡ trá»‹ khÃ´ng pháº£i `roots` sáº½ Ä‘Æ°á»£c giá»¯ láº¡i trong bá»™ nhá»› memory náº¿u:
- CÃ¡c giÃ¡ trá»‹ Ä‘Ã³ ***bá»‹ tham chiáº¿u trá»±c tiáº¿p hoáº·c giÃ¡n tiáº¿p*** bá»Ÿi má»™t `root`
VÃ­ dá»¥

```js
let user = {
  name: "Alice",
  profile: {
    age: 30
  }
};

```

- `user` lÃ  má»™t **biáº¿n global** â†’ lÃ  root.
- `user.profile` Ä‘Æ°á»£c tham chiáº¿u bá»Ÿi `user` â†’ reachable.
- `profile.age` cÅ©ng reachable vÃ¬ Ä‘Æ°á»£c tham chiáº¿u bá»Ÿi `profile`.


JavaScript engine cÃ³ má»™t tiáº¿n trÃ¬nh ná»n gá»i lÃ  **garbage collector**, cÃ³ nhiá»‡m vá»¥:
- **Theo dÃµi táº¥t cáº£ cÃ¡c object trong bá»™ nhá»›**.
- Náº¿u object nÃ o **khÃ´ng cÃ²n reachable** (khÃ´ng thá»ƒ truy cáº­p tá»« root hoáº·c tá»« báº¥t ká»³ chuá»—i tham chiáº¿u nÃ o) â†’ **bá»‹ xÃ³a khá»i bá»™ nhá»›**.

## Thuáº­t toÃ¡n Mark-and-Sweep

Thuáº­t toÃ¡n Mark and Sweep (Ä‘Ã¡nh dáº¥u vÃ  quÃ©t) Ä‘Æ°á»£c  cÃ¡c Javascript Engine hiá»‡n Ä‘áº¡i nhÆ° V8, SpiderMonkey sá»­ dá»¥ng Ä‘á»ƒ implment ***Garbage Collector (GC)***.

### ğŸš¶â€â™‚ï¸ CÃ¡ch hoáº¡t Ä‘á»™ng tá»«ng bÆ°á»›c:

1. **GC báº¯t Ä‘áº§u tá»« cÃ¡c â€œrootsâ€ (gá»‘c)** â€“ nhÆ° biáº¿n toÃ n cá»¥c, hÃ m Ä‘ang cháº¡y, tham sá»‘, stackâ€¦
![[Pasted image 20250527223711.png]]
2. **ÄÃ¡nh dáº¥u táº¥t cáº£ object cÃ³ thá»ƒ truy cáº­p Ä‘Æ°á»£c** tá»« cÃ¡c root.
    - DÃ² theo cÃ¡c **tham chiáº¿u (references)** tá»« root Ä‘áº¿n cÃ¡c object khÃ¡c.
    - Tiáº¿p tá»¥c Ä‘Ã¡nh dáº¥u cÃ¡c object Ä‘Æ°á»£c tham chiáº¿u giÃ¡n tiáº¿p.
    - TrÃ¡nh Ä‘Ã¡nh dáº¥u 2 láº§n cÃ¹ng má»™t object.
    ![[Pasted image 20250527223740.png]]
    ![[Pasted image 20250527223753.png]]
    ![[Pasted image 20250527223802.png]]
3. Khi Ä‘Ã£ Ä‘Ã¡nh dáº¥u xong:
    - **Táº¥t cáº£ object khÃ´ng Ä‘Æ°á»£c Ä‘Ã¡nh dáº¥u â†’ khÃ´ng thá»ƒ truy cáº­p Ä‘Æ°á»£c â†’ bá»‹ xÃ³a khá»i bá»™ nhá»›.**
	![[Pasted image 20250527223819.png]]
###  ğŸ§  **2. CÃ¡c tá»‘i Æ°u hÃ³a hiá»‡n Ä‘áº¡i Ä‘á»ƒ GC hiá»‡u quáº£ hÆ¡n:**

JavaScript engine khÃ´ng chá»‰ dÃ¹ng â€œMark-and-Sweepâ€ thuáº§n tÃºy, mÃ  cÃ²n thÃªm nhiá»u ká»¹ thuáº­t tá»‘i Æ°u Ä‘á»ƒ:
- TÄƒng hiá»‡u nÄƒng
- Giáº£m delay (trá»…) khi dá»n dáº¹p bá»™ nhá»›
### ğŸ”§ CÃ¡c ká»¹ thuáº­t chÃ­nh:
#### ğŸ”¹ **Generational Collection (Thu gom tháº¿ há»‡):**
- PhÃ¢n object thÃ nh 2 nhÃ³m:
    - **Object má»›i (young)**: xuáº¥t hiá»‡n gáº§n Ä‘Ã¢y, thÆ°á»ng chá»‰ sá»‘ng trong thá»i gian ngáº¯n.
    - **Object cÅ© (old)**: tá»“n táº¡i lÃ¢u dÃ i hÆ¡n.
- GC sáº½ **quÃ©t nhÃ³m object má»›i thÆ°á»ng xuyÃªn hÆ¡n**, vÃ¬ Ä‘a sá»‘ object cháº¿t sá»›m (VD: object táº¡m trong function).

#### ğŸ”¹ **Incremental Collection (Thu gom tá»«ng pháº§n):**

- Náº¿u bá»™ nhá»› cÃ³ quÃ¡ nhiá»u object, GC **chia nhá» quÃ¡ trÃ¬nh dá»n dáº¹p thÃ nh nhiá»u bÆ°á»›c nhá»**.
- GiÃºp trÃ¡nh lÃ m chÆ°Æ¡ng trÃ¬nh bá»‹ Ä‘á»©ng trong thá»i gian dÃ i do pháº£i dá»n háº¿t cÃ¹ng lÃºc.

#### ğŸ”¹ **Idle-time Collection (Thu gom lÃºc ráº£nh):**

- GC chá»‰ cháº¡y khi **CPU Ä‘ang ráº£nh**, khÃ´ng áº£nh hÆ°á»Ÿng tá»›i tá»‘c Ä‘á»™ thá»±c thi chÆ°Æ¡ng trÃ¬nh.
- VÃ­ dá»¥: khi báº¡n dá»«ng gÃµ phÃ­m hoáº·c khÃ´ng tÆ°Æ¡ng tÃ¡c trong vÃ i mili-giÃ¢y.