```table-of-contents
```

ğŸ’¡ Trong JavaScript, khi gá»i hÃ m, nÃ³ sáº½ Ä‘Æ°á»£c **Ä‘Æ°a vÃ o ngÄƒn xáº¿p gá»i hÃ m (call stack)**.
 ğŸ’¡Náº¿u stack váº«n cÃ²n Ä‘ang xá»­ lÃ½ cÃ¡c hÃ m **trong call stack**, JavaScript sáº½ **khÃ´ng xá»­ lÃ½ cÃ¡c callback Ä‘ang Ä‘á»£i trong hÃ ng Ä‘á»£i (queue)**.
 
 - **Call stack**: nÆ¡i JavaScript thá»±c thi cÃ¡c hÃ m Ä‘á»“ng bá»™
- **Callback queue**: nÆ¡i chá»©a cÃ¡c callback báº¥t Ä‘á»“ng bá»™ (nhÆ° `setTimeout`, `fs.readFile`, Promise, v.v.)
- ğŸ’¡ğŸ§  **CÆ¡ cháº¿**:
	1. Náº¿u call stack **Ä‘ang rá»—ng** (tá»©c khÃ´ng cÃ²n hÃ m nÃ o Ä‘ang cháº¡y),
	2. Event loop sáº½ láº¥y **callback Ä‘áº§u tiÃªn tá»« queue**,
	3. ÄÆ°a vÃ o call stack Ä‘á»ƒ thá»±c thi.
# Má»™t sá»‘ khÃ¡i niá»‡m vá» event loop

* event loop Ä‘Æ°á»£c cháº¡y trong cÃ¹ng má»™t thread vá»›i code Javascript chÃ­nh lÃ  ***main thread***. Náº¿u <span style="font-weight:bold; color:rgb(255, 0, 0)">block event loop Ä‘á»“ng nghÄ©a vá»›i viá»‡c block main thread</span>.
* KhÃ´ng thá»ƒ start hoáº·c stop event loop. Event loop sáº½ tá»± Ä‘á»™ng *start khi process Ä‘Æ°á»£c start, vÃ  sáº½ káº¿t thÃºc khi khÃ´ng cÃ²n callback nÃ o cáº§n Ä‘Æ°á»£c xá»­ lÃ½*.  Event loop cÃ³ thá»ƒ cháº¡y mÃ£i mÃ£i.
* **Event loop** lÃ  má»™t cÆ¡ cháº¿ trung tÃ¢m trong Nodejs, cho phÃ©p Nodejs xá»­ lÃ½ cÃ¡c tÃ¡c vá»¥ ***non-blocking I/O***.
* Báº£n thÃ¢n Nodejs lÃ  ***Ä‘Æ¡n luá»“ng***, nhÆ°ng viá»‡c offload cÃ¡c operation xuá»‘ng system kernel báº¥t cá»© khi nÃ o cÃ³ thá»ƒ â¡ï¸ Ä‘áº¡t Ä‘Æ°á»£c hiá»‡u nÄƒng tá»‘t.
* Khi cÃ³ cÃ¡c tÃ¡c vá»¥ nhÆ° Ä‘á»c file, truy váº¥n database, chá» káº¿t ná»‘i máº¡ngâ€¦ event loop **khÃ´ng tá»± xá»­ lÃ½** mÃ  sáº½ **giao nhiá»‡m vá»¥ (delegate)** cho **libuv** â€” má»™t thÆ° viá»‡n C cung cáº¥p cÃ¡c API báº¥t Ä‘á»“ng bá»™, cháº¡y dÆ°á»›i ná»n táº£ng Node.js.
* libuv khÃ´ng tá»± xá»­ lÃ½ tá»«ng thao tÃ¡c mÃ  **táº­n dá»¥ng kháº£ nÄƒng cá»§a há»‡ Ä‘iá»u hÃ nh**, cháº³ng háº¡n:
	- Sá»­ dá»¥ng **thread pool** (má»™t nhÃ³m luá»“ng ná»n) Ä‘á»ƒ thá»±c hiá»‡n cÃ¡c cÃ´ng viá»‡c nhÆ° Ä‘á»c ghi file, DNS lookupâ€¦
	- Nhá» váº­y, nÃ³ cÃ³ thá»ƒ xá»­ lÃ½ nhiá»u I/O song song **mÃ  khÃ´ng cháº·n event loop chÃ­nh**.
- Khi tÃ¡c vá»¥ I/O hoÃ n táº¥t, libuv sáº½ **gá»­i tÃ­n hiá»‡u cho event loop** Ä‘á»ƒ thÃ´ng bÃ¡o ráº±ng káº¿t quáº£ Ä‘Ã£ sáºµn sÃ ng.
    
- Event loop sáº½ **xáº¿p callback** tÆ°Æ¡ng á»©ng vÃ o hÃ ng Ä‘á»£i (callback queue) vÃ  xá»­ lÃ½ chÃºng trong chu ká»³ tiáº¿p theo.

ğŸ’¡ Chá»‰ cÃ³ `libuv` lÃ  Ä‘a luá»“ng, cÃ²n báº£n thÃ¢n `Nodejs` lÃ  Ä‘Æ¡n luá»“ng, code Ä‘Æ°á»£c thá»±c thi **tuáº§n tá»±, khÃ´ng cÃ³ shared memory giá»¯a cÃ¡c luá»“ng**, dá»… hiá»ƒu vÃ  trÃ¡nh lá»—i race condition.

# VÃ­ dá»¥ vá» cÃ¡ch nodejs xá»­ lÃ½ báº¥t Ä‘á»“ng bá»™

```js
const fs = require("fs")
fs.readFile('foo.js', {encoding: 'utf8'}, (err, fileContents) => {
	console.log('Then the contents are available', fileContents);
})
console.log('This happens first');
```

Khi thá»±c thi Ä‘oáº¡n code trÃªn, node Ä‘Ã£ lÃ m nhá»¯ng viá»‡c sau:
1. Má»™t process object Ä‘Æ°á»£c táº¡o ra báº±ng C++ sá»­ dá»¥ng V8 API. Trong v8 lÃºc nÃ y, má»™t `Javascript context` Ä‘Æ°á»£c táº¡o ra. Nodejs ***náº¡p cÃ¡c thÃ nh pháº§n cá»‘t lÃµi cá»§a runtime nhÆ° event loop, cÃ¡c module fs, https,...)
2. `fs` module Ä‘Æ°á»£c attach vÃ o Node runtime. Báº£n cháº¥t cá»§a V8 engine lÃ  má»™t javascript wrapper cho cÃ¡c function C++ á»Ÿ pháº§n core, giÃºp js cÃ³ thá»ƒ gá»i tá»›i cÃ¡c code C++ Ä‘á»ƒ Ä‘á»c file
3. Gá»i hÃ m `fs.readFile()` vÃ  truyá»n vÃ o callback
	* HÃ m nÃ y khÃ´ng thá»±c sá»± ***Ä‘á»c file ngay láº­p tá»©c***
	* NÃ³ ***Ä‘Äƒng kÃ½ yÃªu cáº§u Ä‘á»c file*** vá»›i `libuv` báº±ng cÃ¡ch sá»­ dá»¥ng `fs.binding('fs')` â‡’ gá»i binding C++ Ä‘Ã£ gáº¯n vá»›i libuv.
4. `libuv` sáº½ gá»i cÃ¡c hÃ m há»‡ Ä‘iá»u hÃ nh nhÆ° `open`, `read` Ä‘á»ƒ thá»±c thi thao tÃ¡c Ä‘á»c file, `libuv` khÃ´ng dÃ¹ng V8 hay Javascript mÃ  hoÃ n toÃ n dÃ¹ng `native code`.
5. Luá»“ng thá»±c thi cá»§a Nodejs khÃ´ng bá»‹ cháº·n bá»Ÿi `readFile()` vÃ  tiáº¿p tá»¥c cháº¡y cÃ¡c lá»‡nh tiáº¿p theo.
6. Khi OS Ä‘á»c file xong, `libuv` nháº­n Ä‘Æ°á»£c event, thÆ°á»ng lÃ  qua cÆ¡ cháº¿ `epoll`, `kqueue`,.... `libuv` sáº½ gá»i láº¡i callback.
7. Callback Ä‘Æ°á»£c truyá»n vÃ o `fs.readFile` lÃºc Ä‘áº§u sáº½ Ä‘Æ°á»£c ***xáº¿p vÃ o hÃ ng Ä‘á»£i callback***. Event loop cá»§a node sáº½ **thá»±c thi callback Ä‘Ã³ ngay sau khi call stack trá»‘ng**.
8. Thá»±c thi callback
9. Khi khÃ´ng cÃ²n callback hoáº·c tÃ¡c vá»¥ nÃ o khÃ¡c, **event loop dá»«ng láº¡i, Nodejs sáº½ káº¿t thÃºc tiáº¿n trÃ¬nh**.

```bash
JS â†’ fs.readFile() 
â†’ fs.binding() â†’ C++ binding 
â†’ libuv â†’ OS (read file) 
â†’ libuv callback â†’ V8 callback queue 
â†’ Event loop â†’ cháº¡y láº¡i callback trong JS
â†’ In ra ná»™i dung file
â†’ KhÃ´ng cÃ²n callback â†’ process káº¿t thÃºc
```

# Event loop ordering, phases, and priorities

```sql
	â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”Œâ”€â”€â–¶â”‚   timers      â”‚
|	â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
|	       â”‚
|	â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”
|	â”‚ I/O callbacks â”‚
|	â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
|	       â”‚
|	â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”
|	â”‚ idle, prepare â”‚
|	â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
|	       â”‚
|	â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
|	â”‚      poll         â”œâ”€â”€â”€â”€â”€â”€â–¶ incoming: connections, dataâ€¦  â”‚
|	â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
|	       â”‚
|	â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”
|	â”‚    check      â”‚
|	â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
|	       â”‚
|	â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â””â”€â”€â”€â”‚ close callbacks   â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

Event loop sáº½ Ä‘Æ°á»£c xá»­ lÃ½ thÃ´ng qua nhiá»u phases.
<span style="font-style:italic; color:rgb(255, 0, 0)">Má»—i pharse sáº½ cÃ³ má»™t queue riÃªng chá»©a cÃ¡c event Ä‘á»ƒ xá»­ lÃ½</span>.

Má»™t sá»‘ pharse cáº§n lÆ°u Ã½:

<span style="font-weight:bold; color:rgb(255, 0, 0)">Timers</span>: á» pharse nÃ y, node sáº½ xá»­ lÃ½ cÃ¡c callback Ä‘Æ°á»£c láº­p lá»‹ch trÆ°á»›c Ä‘Ã³ báº±ng `setTimeout()` hoáº·c `setInterval()`. 
* VÃ­ dá»¥ khi gá»i `setTimeout(callback, 1000)`, Nodejs khÃ´ng Ä‘Æ°a ngay callback vÃ o call stack mÃ  ghi nhá»› callbacknafy vá»›i thá»i gian chá» `1000ms`, sau Ä‘Ã³ theo dÃµi báº±ng timer ná»™i bá»™
* Sau khi chá» Ä‘á»§ `1000ms`, callback Ä‘Æ°á»£c ***Ä‘áº©y vÃ o hÃ ng Ä‘á»£i cá»§a phases Timers***.
* Trong vÃ²ng láº·p tiáº¿p theo cá»§a event loop. Event loop ***kiáº¿m tra xem cÃ³ callback nÃ o trong hÃ ng Ä‘á»£i Timers*** khÃ´ng. Náº¿u cÃ³ thÃ¬ sáº½ Ä‘áº©y vÃ o call stack Ä‘á»ƒ thá»±c thi.

<span style="font-weight:bold; color:rgb(255, 0, 0)">I/O callbacks</span>:  phases nÃ y sáº½ xá»­ lÃ½ cÃ¡c callback Ä‘Æ°á»£c láº­p lá»‹ch bá»Ÿi cÃ¡c thao tÃ¡c I/O
* CÃ¡c thao tÃ¡c I/O (Ä‘á»c file , nghe káº¿t ná»‘i máº¡ng,..) thÆ°á»ng Ä‘Æ°á»£c Nodejs xá»­ lÃ½ báº±ng ***thread pool*** á»Ÿ táº§ng tháº¥p thÃ´ng qua `libuv`.
* Sau khi thá»±c thi I/O xong, `libuv` sáº½ Ä‘Æ°a káº¿t quáº£ cá»§a I/O vÃ  callback tÆ°Æ¡ng á»©ng vÃ o queue cá»§a phases I/O callbacks, vÃ  sáº½ Ä‘Æ°á»£c `main thread` xá»­ lÃ½ khi event loop tá»›i phases nÃ y.
> Chá»‰ cáº§n lÃ m rÃµ ráº±ng khÃ´ng pháº£i **táº¥t cáº£ I/O Ä‘á»u dÃ¹ng thread pool**, vÃ  thread pool chá»§ yáº¿u dÃ¹ng cho **blocking I/O hoáº·c CPU-bound tasks**

<span style="font-weight:bold; color:rgb(255, 0, 0)">Poll Phases</span> :
* Táº¡i phases nÃ y, **CÃ¡c I/O events** (Ä‘á»c file, káº¿t ná»‘i máº¡ng, socket, stream...) Ä‘Æ°á»£c xá»­ lÃ½ **khi káº¿t quáº£ Ä‘Ã£ sáºµn sÃ ng**. VÃ­ dá»¥ nhÆ° file Ä‘Æ°á»£c Ä‘á»c xong, dá»¯ liá»‡u Ä‘áº¿n socket,...
* Khi báº¡n má»™t hÃ m I/O trong Node.js (nhÆ° `fs.readFile`, `net.connect`, `http.request`...), hÃ m Ä‘Ã³ khÃ´ng thá»±c thi ngay láº­p tá»©c.
	* Node.js **gá»­i yÃªu cáº§u I/O xuá»‘ng táº§ng libuv**.
	* `libiv` sáº½ giao tiáº¿p vá»›i OS (sá»­ dá»¥ng `epoll`, `kqueue`, `IOCP` tÃ¹y há»‡ Ä‘iá»u hÃ nh) Ä‘á»ƒ theo dÃµi tráº¡ng thÃ¡i cÃ¡c I/O.
	* Khi I/O sáºµn sÃ ng (vÃ­ dá»¥ file Ä‘á»c xong, socket cÃ³ dá»¯ liá»‡u), **libuv sáº½ Ä‘áº©y callback vÃ o hÃ ng Ä‘á»£i cá»§a poll phase**.
	
* <span style="color:rgb(0, 176, 80)">Náº¿u queue cá»§a poll phases rá»—ng thÃ¬ sáº½ cÃ³ 3 trÆ°á»ng há»£p</span>:
	* **Block chá»** (náº¿u cÃ²n I/O Ä‘ang chá» dá»¯ liá»‡u, vÃ­ dá»¥ socket).
	*  **Chuyá»ƒn sang check phase** (náº¿u cÃ³ `setImmediate()` Ä‘ang chá»).
	- **Káº¿t thÃºc chÆ°Æ¡ng trÃ¬nh** (náº¿u khÃ´ng cÃ²n viá»‡c gÃ¬ Ä‘á»ƒ lÃ m).

<span style="font-weight:bold; color:rgb(255, 0, 0)">Check Phases</span> :
* ChuyÃªn xá»­ lÃ½ cÃ¡c callback cá»§a `setImmediate()`.
* CÃ¡c callback `setImmediate()` **luÃ´n Ä‘Æ°á»£c cháº¡y sau poll phase**, **trong check phase**.
* VÃ­ dá»¥
```js
setTimeout(() => console.log('timeout'), 0);
setImmediate(() => console.log('immediate'));
```

* trong workflow bÃ¬nh thÆ°á»ng, callback cá»§a `setTimeout` thÆ°á»ng sáº½ Ä‘Æ°á»£c cháº¡y trÆ°á»›c callback cá»§a `setImmediate` (<span style="color:rgb(0, 176, 80)">khÃ´ng pháº£i luÃ´n luÃ´n</span> vÃ¬ cÃ²n phá»¥ thuá»™c vÃ o tá»‘c Ä‘á»™ thá»±c hiá»‡n cá»§a event loop, Ä‘á»™ phÃ¢n giáº£i timer, ...)
* Tuy nhiÃªn, náº¿u Ä‘áº·t Ä‘oáº¡n code trÃªn trong má»™t I/O callback (vÃ­ dá»¥ trong callback cá»§a `fs.readFile()`) thÃ¬ callback cá»§a `setImmediate` gáº§n nhÆ° luÃ´n luÃ´n Ä‘Æ°á»£c cháº¡y trÆ°á»›c `setTimeout`

<span style="font-weight:bold; color:rgb(255, 0, 0)"><code>process.nextTick()</code> - microstask Ä‘áº·c biá»‡t</span> 
* `process.nextTick()` <span style="color:rgb(0, 176, 80)"><span style="color:rgb(255, 0, 0)">khÃ´ng pháº£i lÃ  má»™t phases</span></span>, mÃ  lÃ  má»™t <span style="color:rgb(0, 176, 80)">microtask queue riÃªng</span>.
* CÃ¡c callback cá»§a `process.nextTick` <span style="font-weight:bold; color:rgb(0, 176, 80)">luÃ´n Ä‘Æ°á»£c cháº¡y ngay sau khi call stack rá»—ng, trÆ°á»›c khi event loop chuyá»ƒn sang phase tiáº¿p theo</span>.

|Loáº¡i callback|Khi nÃ o cháº¡y|
|---|---|
|`setTimeout(cb, 0)`|Trong **Timers phase**|
|`setImmediate(cb)`|Trong **Check phase**|
|`I/O callback`|Trong **Poll phase**|
|`process.nextTick(cb)`|**Ngay sau khi call stack rá»—ng**, trÆ°á»›c má»i phase|
## âœ… Sá»± khÃ¡c nhau giá»¯a **Poll phase** vÃ  **I/O Callbacks phase**

|Äiá»ƒm so sÃ¡nh|**Poll phase**|**I/O callbacks phase**|
|---|---|---|
|ğŸ“Œ Vá»‹ trÃ­ trong event loop|Sau â€œidle/prepareâ€ vÃ  trÆ°á»›c â€œcheckâ€|Ngay sau phase "timers"|
|ğŸ“š Xá»­ lÃ½ loáº¡i I/O nÃ o?|Xá»­ lÃ½ **I/O readiness** (dá»¯ liá»‡u Ä‘áº¿n tá»« socket, TCP, v.v.)|Xá»­ lÃ½ **deferred callbacks** (Ä‘Ã£ bá»‹ trÃ¬ hoÃ£n tá»« vÃ²ng trÆ°á»›c)|
|ğŸ§  VÃ­ dá»¥ Ä‘iá»ƒn hÃ¬nh|Dá»¯ liá»‡u Ä‘áº¿n tá»« `net`, `http`, `fs`, `readable` stream|`fs.close`, `DNS`, `setTimeout` bá»‹ delay, `TCP wrap errors`|
|ğŸ” CÃ³ thá»ƒ block khÃ´ng?|âœ… CÃ³ thá»ƒ block táº¡m thá»i náº¿u khÃ´ng cÃ³ viá»‡c khÃ¡c|âŒ KhÃ´ng block, chá»‰ xá»­ lÃ½ callback Ä‘Ã£ cÃ³|
|ğŸ”„ Di chuyá»ƒn tiáº¿p theo|Sau poll cÃ³ thá»ƒ chuyá»ƒn sang **check** hoáº·c quay láº¡i timers|Di chuyá»ƒn sang phase â€œidle/prepareâ€ â†’ â€œpollâ€|
