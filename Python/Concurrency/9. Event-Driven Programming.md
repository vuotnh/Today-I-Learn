```table-of-contents
```
# Event-driven programming

Trong cÃ¡c chÆ°Æ¡ng trÃ¬nh ***Event-driven***, chÃºng ta thÆ°á»ng cÃ³ má»™t ****vÃ²ng láº·p sá»± kiá»‡n (event loop)*** â€” má»™t tiáº¿n trÃ¬nh cháº¡y liÃªn tá»¥c Ä‘á»ƒ ***láº¯ng nghe cÃ¡c sá»± kiá»‡n Ä‘áº¿n**** (nhÆ° nháº¥n phÃ­m, káº¿t ná»‘i máº¡ng, hay timer).

Khi event loop Ä‘Ã£ báº¯t Ä‘áº§u cháº¡y, toÃ n bá»™ hÃ nh vi cá»§a chÆ°Æ¡ng trÃ¬nh sáº½ phá»¥ thuá»™c vÃ o ****cÃ¡c sá»± kiá»‡n mÃ  ngÆ°á»i dÃ¹ng (hoáº·c há»‡ thá»‘ng) Ä‘Æ°a vÃ o***.

![[Pasted image 20250617232129.png]]
SÆ¡ Ä‘á»“ trÃªn mÃ´ táº£ Ä‘Æ¡n giáº£n cÃ¡c hoáº¡t Ä‘á»™ng cá»§a event loop, 
Khi event loop báº¯t Ä‘áº§u cháº¡y, nÃ³ sáº½ vÃ o tráº¡ng thÃ¡i ***Wait***.
Tráº¡ng thÃ¡i ***Wait*** ***kÃ©o dÃ i vÃ´ háº¡n*** cho Ä‘áº¿n khi:
1. Má»™t event cá»¥ thá»ƒ xáº£y ra
2. ChÆ°Æ¡ng trÃ¬nh gáº·p lá»—i vÃ  crashed

Trong tráº¡ng thÃ¡i ***Wait***, chÆ°Æ¡ng trÃ¬nh ***liÃªn tá»¥c láº¯ng nghe cÃ¡c event Ä‘áº¿n*** vÃ  ***chuyá»ƒn tiáº¿p (dispatch)*** cÃ¡c event Ä‘Ã³ Ä‘áº¿n cÃ¡c ***event handler*** (cÃ¡c hÃ m xá»­ lÃ½ sá»± kiá»‡n) tÆ°Æ¡ng á»©ng.

ğŸ“ VÃ­ dá»¥:
- Sá»± kiá»‡n `"click"` gá»i hÃ m `handle_click()`
- Sá»± kiá»‡n `"keypress"` gá»i `handle_keypress()`

## The event loop

ThÃ nh pháº§n **quan trá»ng nháº¥t** trong báº¥t ká»³ chÆ°Æ¡ng trÃ¬nh Python nÃ o viáº¿t theo mÃ´ hÃ¬nh **hÆ°á»›ng sá»± kiá»‡n** chÃ­nh lÃ  <span style="font-weight:bold; color:rgb(255, 0, 0)">event loop</span> â€” vÃ²ng láº·p Ä‘iá»u phá»‘i má»i sá»± kiá»‡n.

- NÃ³ lÃ  trung tÃ¢m váº­n hÃ nh toÃ n bá»™ logic xá»­ lÃ½ báº¥t Ä‘á»“ng bá»™ trong `asyncio`, `FastAPI`, `aiohttp`, v.v.

Láº¥y vÃ­ dá»¥ vá»›i ***event loop*** trong `asyncio`, trong ***event loop*** ta cÃ³ thá»ƒ lÃ m cÃ¡c viá»‡c sau:
1. Register, execute, and cancel calls
	- **Ä‘Äƒng kÃ½ (register)** má»™t function (coroutine hoáº·c callback)
	- **Thá»±c thi (execute)** coroutine hoáº·c callback khi Ä‘iá»u kiá»‡n phÃ¹ há»£p
	- cÃ³ thá»ƒ **há»§y bá» (cancel)** náº¿u task Ä‘Ã³ khÃ´ng cÃ²n cáº§n thiáº¿t ná»¯a
```python
task = asyncio.create_task(my_coroutine())
task.cancel()
```
2. Táº¡o cÃ¡c tiáº¿n trÃ¬nh con ***sub-processes***
	- Event loop cÃ³ thá»ƒ khá»Ÿi cháº¡y **tiáº¿n trÃ¬nh con (subprocess)**, vÃ­ dá»¥ nhÆ° gá»i má»™t chÆ°Æ¡ng trÃ¬nh bÃªn ngoÃ i (`ffmpeg`, `curl`, ...)
	- quáº£n lÃ½ **giao tiáº¿p (transport)** giá»¯a chÆ°Æ¡ng trÃ¬nh chÃ­nh vÃ  tiáº¿n trÃ¬nh con thÃ´ng qua stdin, stdout, hoáº·c socket.
```python
process = await asyncio.create_subprocess_exec('ls', '-la')
```
3. Xá»­ lÃ½ cÃ¡c hÃ m ***tá»‘n thá»i gian xá»­ lÃ½ (CPU-bound)*** hoáº·c ***khÃ´ng pháº£i async***
	- Ä‘áº©y cÃ¡c hÃ m ***CPU-bound*** vÃ o cÃ¡c thread pool Ä‘á»ƒ cháº¡y song song mÃ  ko lÃ m block event loop
```python
from concurrent.futures import ThreadPoolExecutor

loop = asyncio.get_event_loop()
result = await loop.run_in_executor(None, heavy_function)
```


**TÃ³m láº¡i**, event loop chá»‰ lÃ m má»™t viá»‡c chÃ­nh:

- **Chá» cÃ¡c sá»± kiá»‡n xáº£y ra** (event: timeout, network, keyboard, v.v.)
- Khi sá»± kiá»‡n xáº£y ra, nÃ³ sáº½ tÃ¬m xem cÃ³ **hÃ m nÃ o Ä‘Æ°á»£c Ä‘Äƒng kÃ½ xá»­ lÃ½ loáº¡i sá»± kiá»‡n Ä‘Ã³** rá»“i gá»i hÃ m Ä‘Ã³ Ä‘á»ƒ xá»­ lÃ½.

> ğŸ’¡ Má»—i loáº¡i sá»± kiá»‡n sáº½ Ä‘Æ°á»£c gáº¯n vá»›i má»™t "handler" cá»¥ thá»ƒ.


