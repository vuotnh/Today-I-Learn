```table-of-contents
```
# Concurrent futures

***Concurrent futures*** lÃ  futures má»›i Ä‘Æ°á»£c thÃªm vÃ o Python 3.2

Khi cÃ¡c chÆ°Æ¡ng trÃ¬nh thá»±c thi cÃ¡c multithreaded task, má»™t trong nhá»¯ng tÃ¡c vá»¥ tá»‘n nhiá»u tÃ i nguyÃªn nháº¥t lÃ  *viá»‡c start cÃ¡c thread*.
`ThreadPoolExecutors` giÃºp giáº£i quyáº¿t váº¥n Ä‘á» nÃ y báº±ng cÃ¡c táº¡o ra má»™t `pool of threads`. CÃ¡c threads mÃ  chÆ°Æ¡ng trÃ¬nh táº¡o ra sáº½ Ä‘Æ°á»£c tá»“n táº¡i trong pool.
* ChÆ°Æ¡ng trÃ¬nh táº¡o ra cÃ¡c thread Ä‘á»ƒ thá»±c thi task.
* CÃ¡c thread sau khi táº¡o ra sáº½ Ä‘Æ°á»£c thÃªm vÃ o trong pool.
* Sau khi thread thá»±c thi xong task, nÃ³ khÃ´ng bá»‹ kill ngay mÃ  váº«n tá»“n táº¡i trong pool.
* Sau Ä‘Ã³ chÆ°Æ¡ng trÃ¬nh sáº½ ***tÃ¡i sá»­ dá»¥ng*** láº¡i cÃ¡c threads trong pool mÃ  ***khÃ´ng cáº§n táº¡o thÃªm thread má»›i***.

â¡ï¸ Thay vÃ¬ pháº£i táº¡o ra cÃ¡c thread má»›i, run thread Ä‘á»ƒ thá»±c thi task, kill thread, vÃ  láº·p láº¡i nhÆ° tháº¿ má»—i khi cáº§n thÃ¬ `ThreadPoolExecutors` giÃºp chá»‰ ta táº¡o thread 1 láº§n vÃ  gá»i chÃºng má»—i khi cáº§n â‡’ Tiáº¿t kiá»‡m tÃ i nguyÃªn

## Táº¡o má»™t ThreadPoolExecutor

```python
executor = ThreadPoolExecutor(max_workers=3)
```

Khá»Ÿi táº¡o má»™t instance cá»§a `ThreadPoolExecutor`, truyá»n vÃ o sá»‘ lÆ°á»£ng worker tá»‘i Ä‘a lÃ  3 â†” trong pool sáº½ cÃ³ tá»‘i Ä‘a 3 thread hoáº¡t Ä‘á»™ng Ä‘á»“ng thá»i.

Ta cÃ³ thá»ƒ yÃªu cáº§u threads thá»±c thi má»™t function thÃ´ng qua method `submit()`, truyá»n vÃ o tÃªn function vÃ  cÃ¡c parameter cá»§a func muá»‘n thá»±c thi.
```python
executor.submit(myFunction())
```

```python
from concurrent.futures import ThreadPoolExecutor
import threading
import random
def task():
    print("Executing our Task")
    result = 0
    i = 0
    for i in range(10):
        result = result + i
    print("I: {}".format(result))
    print("Task Executed {}".format(threading.current_thread()))

def main():
    executor = ThreadPoolExecutor(max_workers=3)
    task1 = executor.submit(task)
    task2 = executor.submit(task)
    task3 = executor.submit(task)
    task4 = executor.submit(task)
    task4 = executor.submit(task)
    task4 = executor.submit(task)
    task4 = executor.submit(task)
if __name__ == '__main__':
    main()
```

Trong vÃ­ dá»¥ trÃªn, ta tháº¥y chá»‰ cÃ³ 3 thread thay phiÃªn nhau thá»±c thi cÃ¡c task.

## Context manager

Instance cá»§a `ThreadPoolExecutor` cÃ²n Ä‘Æ°á»£c sá»­ dá»¥ng nhÆ° má»™t ***context manager***.
```python
with ThreadPoolExecutor(max_workers=3) as executor:
	
```

CÃ¡c sá»­ dá»¥ng trÃªn sáº½ hoáº¡t Ä‘á»™ng tÆ°Æ¡ng tá»± nhÆ° instance bÃ¬nh thÆ°á»ng, tuy nhiÃªn nÃ³ táº¡o ra má»™t ***Context Manager*** bá»c quanh code vÃ  cho phÃ©p custom (Ä‘á»c thÃªm: [[With Context manager]])

```python
from concurrent.futures import ThreadPoolExecutor 

def task(n):
    print("Processing {}".format(n))

def main():
    print("Starting ThreadPoolExecutor")
    with ThreadPoolExecutor(max_workers=3) as executor:
        future = executor.submit(task, (2))
        future = executor.submit(task, (3))
        future = executor.submit(task, (4))
    print("All tasks complete")
if __name__ == '__main__':
    main()
```

## Maps
```python
from concurrent.futures import ThreadPoolExecutor
values = [2,3,4,5,6,7,8]
def multiplyByTwo(n):
    return 2 * n

def main():
    with ThreadPoolExecutor(max_workers=3) as executor:
        results = executor.map(multiplyByTwo, values)
        for result in results:
            print(result)
if __name__ == '__main__':
    main()
```

## Shutdown executor objects

- Khi **shutdown** (táº¯t) má»™t **executor object** (vÃ­ dá»¥ nhÆ° `ThreadPoolExecutor`, `ProcessPoolExecutor` trong Python), **chÆ°Æ¡ng trÃ¬nh khÃ´ng dá»«ng ngay láº­p tá»©c cÃ¡c task** Ä‘ang cháº¡y.
- **Shutdown** nghÄ©a lÃ : **executor sáº½ khÃ´ng nháº­n thÃªm task má»›i ná»¯a**.
- CÃ¡c **task Ä‘ang cháº¡y hoáº·c Ä‘Ã£ Ä‘Æ°á»£c submit** trÆ°á»›c khi shutdown **sáº½ tiáº¿p tá»¥c cháº¡y cho Ä‘áº¿n khi hoÃ n thÃ nh**.
- Náº¿u cá»‘ gáº¯ng **submit** (ná»™p) má»™t task má»›i sau khi Ä‘Ã£ shutdown â†’ **sáº½ bá»‹ lá»—i** (exception).
```python
import time
from concurrent.futures import ThreadPoolExecutor

def someTask(n):
    print("Executing Task {}".format(n))
    time.sleep(n)
    print("Task {} Finished Executing".format(n))

def main():
    with ThreadPoolExecutor(max_workers=2) as executor:
        task1 = executor.submit(someTask, (1))
        task2 = executor.submit(someTask, (2))
        executor.shutdown(wait=True)
        task3 = executor.submit(someTask, (3))
        task4 = executor.submit(someTask, (4))
if __name__ == '__main__':
    main()
```

- Khi gá»i `shutdown()`, executor sáº½ **khÃ´ng nháº­n thÃªm task má»›i**, nhÆ°ng **khÃ´ng giáº¿t cÃ¡c thread ngay**.
- CÃ¡c thread trong thread pool **sáº½ tiáº¿p tá»¥c hoÃ n thÃ nh cÃ¡c task Ä‘Ã£ nháº­n**.
- **Sau khi toÃ n bá»™ task cháº¡y xong**, cÃ¡c thread **sáº½ Ä‘Æ°á»£c tá»± Ä‘á»™ng clean up** (tá»©c lÃ  cÃ¡c thread sáº½ káº¿t thÃºc, giáº£i phÃ³ng tÃ i nguyÃªn nhÆ° RAM, OS handles...).
- Cuá»‘i cÃ¹ng, **thread pool executor** cÅ©ng sáº½ **hoÃ n toÃ n Ä‘Ã³ng láº¡i**.

---
# Future objects

Khi `submit` má»™t task vÃ o `executor`, `executor` sáº½ táº¡o ra má»™t `Future object` tÆ°Æ¡ng á»©ng vá»›i task Ä‘Ã³.

`Future object` Ä‘áº¡i diá»‡n cho ***káº¿t quáº£ cá»§a task Ä‘Ã³ trong tÆ°Æ¡ng lai***:
* ngay khi vá»«a submit tas, task chÆ°a cháº¡y trong nÃªn chÆ°a cÃ³ káº¿t quáº£
* dÃ¹ng `Future object` Ä‘á»ƒ ***theo dÃµi, chá»*** hoáº·c ***láº¥y káº¿t quáº£*** sau khi task cháº¡y xong.

## Má»™t sá»‘ method cá»§a future objects

***result()***
```python
future_obj.result(timeout=None)
```
`timeout` sáº½ giá»›i háº¡n thá»i gian chá» cá»§a future object, náº¿u thá»i gian chá» thá»±c thi task > `timeout`, chÆ°Æ¡ng trÃ¬nh sáº½ raise lá»—i

***add_done_callback()***
```python
future_obj.add_done_callback(myFunc)
```
Truyá»n vÃ o má»™t callback function, sau khi future object cháº¡y xong sáº½ cháº¡y callback function nÃ y.

***.running()***
```python
future_object.running()
```
Tráº£ vá» tráº¡ng thÃ¡i hiá»‡n táº¡i cá»§a future object, cÃ³ Ä‘ang running hay ko.

***cancel()***
dÃ¹ng Ä‘á»ƒ cancel má»™t future object

***exception()***
Khi submit má»™t task vÃ  nháº­n vá» má»™t `Future` object, náº¿u task Ä‘Ã³ gáº·p lá»—i vÃ  throw `Exception`, thÃ¬ `exception` sáº½ Ä‘Æ°á»£c lÆ°u trong `Future`.
CÃ³ thá»ƒ dÃ¹ng `.exception()` Ä‘á»ƒ láº¥y ra lá»—i náº¿u cÃ³.

Náº¿u báº¡n truyá»n thÃªm tham sá»‘ `timeout=x`, thÃ¬ `.exception(timeout=x)` sáº½:
- **Chá» tá»‘i Ä‘a `x` giÃ¢y** Ä‘á»ƒ task hoÃ n thÃ nh.
- Náº¿u trong `x` giÃ¢y task chÆ°a hoÃ n thÃ nh â” **nÃ³ sáº½ nÃ©m ra `TimeoutError`**.

***.done()***
Kiá»ƒm tra xem future object cÃ³ thá»±c thi thÃ nh cÃ´ng hay bá»‹ cancelled.


## Cancelling callable

ChÃºng ta chá»‰ cÃ³ thá»ƒ cancel má»™t task ***sau khi Ä‘Æ°á»£c submit, nhÆ°ng chÆ°a Ä‘Æ°á»£c thá»±c thi***.
***Khi task Ä‘ang Ä‘Æ°á»£c thá»±c thi thÃ¬ khÃ´ng cÃ³ cÃ¡ch nÃ o Ä‘á»ƒ cancel***.

`.cancel()` sáº½ tráº£ vá» má»™t boolean

```python
with ThreadPoolExecutor(max_workers=2) as executor:
	myTask = executor.submit(someTask, (1))
	print(myTask.cancel())
```

```python
import random
from concurrent.futures import ThreadPoolExecutor

def someTask(n):
    print("Executing Task {}".format(n))
    time.sleep(n)
    print("Task {} Finished Executing".format(n))

def main():
    with ThreadPoolExecutor(max_workers=2) as executor:
        task1 = executor.submit(someTask, (1))
        task2 = executor.submit(someTask, (2))
        task3 = executor.submit(someTask, (3))
        task4 = executor.submit(someTask, (4))
        print(task3.cancel())

if __name__ == '__main__':
    main()
```

Trong vÃ­ dá»¥ trÃªn, chá»‰ cÃ³ 2 worker, nÃªn task3 tuy Ä‘Æ°á»£c submit nhÆ°ng váº«n chÆ°a Ä‘Æ°á»£c thá»±c thi (do chá» task1 vÃ  task2 thá»±c hiá»‡n xong), nÃªn váº«n cÃ³ thá»ƒ cancel (tráº£ vá» True).
Tuy nhiÃªn náº¿u tÄƒng sá»‘ worker lÃªn 4, thÃ¬ ngay khi submit, task3 Ä‘Ã£ Ä‘Æ°á»£c assign cho thread Ä‘á»ƒ thá»±c thi â‡’ khÃ´ng thá»ƒ bá»‹ cancel.


## Sá»­ dá»¥ng as_completed Ä‘á»ƒ handle káº¿t quáº£

- BÃ¬nh thÆ°á»ng báº¡n cÃ³ thá»ƒ dÃ¹ng `executor.map()` Ä‘á»ƒ **cháº¡y nhiá»u task song song** vÃ  **láº¥y káº¿t quáº£** dá»… dÃ ng.
- NhÆ°ng **`map()` Ä‘á»£i táº¥t cáº£ task xong theo Ä‘Ãºng thá»© tá»±** â†’ nhiá»u khi **khÃ´ng linh hoáº¡t** náº¿u báº¡n muá»‘n **xá»­ lÃ½ káº¿t quáº£ nÃ o xong trÆ°á»›c thÃ¬ lÃ m luÃ´n**.
- VÃ¬ váº­y, **thay vÃ¬ `map()`**, báº¡n cÃ³ thá»ƒ **tá»± `submit()` tá»«ng task**, lÆ°u cÃ¡c `Future` vÃ o má»™t **danh sÃ¡ch**
- Sau Ä‘Ã³ dÃ¹ng **`as_completed()`**, má»™t hÃ m cá»§a `concurrent.futures`, Ä‘á»ƒ:
    - **Duyá»‡t qua cÃ¡c future nÃ o hoÃ n thÃ nh trÆ°á»›c**, **xá»­ lÃ½ káº¿t quáº£ ngay láº­p tá»©c**.
    - KhÃ´ng cáº§n pháº£i Ä‘á»£i táº¥t cáº£ xong má»›i xá»­ lÃ½.
***Task nÃ o xong trÆ°á»›c thÃ¬ Ä‘Æ°á»£c xá»­ lÃ½ trÆ°á»›c***.

```python
from concurrent.futures import ThreadPoolExecutor, as_completed
import time
import random

def work(x):
    sleep_time = random.randint(1, 5)
    time.sleep(sleep_time)
    return f"Done {x} in {sleep_time} seconds"

executor = ThreadPoolExecutor(max_workers=3)

# Submit nhiá»u task, lÆ°u Future vÃ o danh sÃ¡ch
futures = [executor.submit(work, i) for i in range(5)]

# DÃ¹ng as_completed Ä‘á»ƒ xá»­ lÃ½ tá»«ng Future ngay khi nÃ³ xong
for future in as_completed(futures):
    result = future.result()
    print(result)

executor.shutdown()
```

**Diá»…n giáº£i ngáº¯n gá»n:**
- **BÆ°á»›c 1:** Báº¡n submit nhiá»u task â†’ cÃ³ 1 list `futures`.
- **BÆ°á»›c 2:** Gá»i `for future in as_completed(futures)`:
    - `as_completed` sáº½ **tá»± chá»** cho tá»›i khi tá»«ng task hoÃ n thÃ nh.
    - Má»—i láº§n cÃ³ 1 task xong â†’ nÃ³ yield ra `future` Ä‘Ã³ cho báº¡n xá»­ lÃ½ luÃ´n.
- **BÆ°á»›c 3:** Khi táº¥t cáº£ `futures` Ä‘Ã£ hoÃ n thÃ nh â†’ vÃ²ng láº·p káº¿t thÃºc.

## Exception classes

Khi sá»­ dá»¥ng ***child thread trong python (káº¿ thá»«a tá»« `threading.Thread`)*** thÃ¬:
* Náº¿u thread Ä‘Ã³ cÃ³ `exception`, Python máº·c Ä‘á»‹nh sáº½ khÃ´ng raise lá»—i Ä‘Ã³ ra ngoÃ i, do thread con cháº¡y riÃªng láº» so vá»›i main thread
* Äá»ƒ báº¯t Ä‘Æ°á»£c `exception` cá»§a thread con, sáº½ pháº£i dÃ¹ng `queue`, khi thread cÃ³ exception â‡’Ä‘áº©y exception Ä‘Ã³ vÃ o queue, rá»“i dÃ¹ng thread khÃ¡c Ä‘á»ƒ Ä‘á»c queue ğŸ¥²ğŸ¥²

Khi sá»­ dá»¥ng `ThreadPoolExecutor` hoáº·c `ProcessPoolExecutor` thÃ¬ toÃ n bá»™ result vÃ  exception cá»§a thread con sáº½ Ä‘á»u Ä‘Æ°á»£c Ä‘áº©y vÃ o `Future object`. Do Ä‘Ã³, á»Ÿ main thread
* gá»i `.result()` trÃªn `Future` Ä‘á»ƒ láº¥y káº¿t quáº£ cá»§a task, ***náº¿u cÃ³ lá»—i thÃ¬ sáº½ raise lá»—i á»Ÿ main thread***.
* gá»i `.exception` trÃªn `Future` Ä‘á»ƒ láº¥y ra exception cá»§a task

```python
from concurrent.futures import ThreadPoolExecutor
import concurrent.futures

def isEven(n):
    print("Checking if {} is even".format(n))
    if type(n) != int:
        raise Exception("Value entered is not an integer")
    if n % 2 == 0:
        print("{} is even".format(n))
        return True
    else:
        print("{} is odd".format(n))
        return False
    
def main():
    with ThreadPoolExecutor(max_workers=4) as executor:
        task1 = executor.submit(isEven, (2))
        task2 = executor.submit(isEven, (3))
        task3 = executor.submit(isEven, ('t'))

    for future in concurrent.futures.as_completed([task1, task2, task3]):
        print("Result of Task: {}".format(future.result()))

if __name__ == '__main__':
    main()

```

---
# ProcessPoolExecutor

Hoáº¡t Ä‘á»™ng tÆ°Æ¡ng tá»± `ThreadPoolExecutors` , chá»‰ khÃ¡c lÃ  thay vÃ¬ táº¡o ra cÃ¡c thread thÃ¬ nÃ³ táº¡o ra cÃ¡c process.

## Táº¡o má»™t ProcessPoolExecutor
```python
executor = ProcessPoolExecutor(max_workers=3)
```

***LÆ°u Ã½***: chá»‰ nÃªn dÃ¹ng cÃ¡c process vá»›i cÃ¡c tÃ¡c vá»¥ náº·ng, yÃªu cáº§u nhiá»u CPU, yÃªu cáº§u nhiá»u tÃ i nguyÃªn tÃ­nh toÃ¡n. *Äá»‘i vá»›i cÃ¡c tÃ¡c vá»¥ nháº¹ thÃ¬ nÃªn dÃ¹ng single process vÃ¬ viá»‡c khá»Ÿi táº¡o process má»›i yÃªu cáº§u khÃ¡ nhiá»u tÃ i nguyÃªn.*

```python
from concurrent.futures import ProcessPoolExecutor
import os

def task():
    print("Executing our Task on Process {}".format(os.getpid()))

def main():
    executor = ProcessPoolExecutor(max_workers=3)
    task1 = executor.submit(task)
    task2 = executor.submit(task)

if __name__ == '__main__':
    main()
```

## Context Manager
```python
from concurrent.futures import ProcessPoolExecutor
import os
import time

def task(index):
    time.sleep(3)
    print("Executing our Task on Process {} {}".format(index, os.getpid()))

def main():
    print("Starting ThreadPoolExecutor")
    with ProcessPoolExecutor(max_workers=3) as executor:
        future = executor.submit(task, (2))
        future = executor.submit(task, (3))
        future = executor.submit(task, (4))

    print("All tasks complete")

if __name__ == '__main__':
    main()
```

***ChÃº Ã½***: cáº§n thÃªm `time.sleep`, vÃ¬ task quÃ¡ Ä‘Æ¡n giáº£n, cÃ³ thá»ƒ 1 process sáº½ chiáº¿m háº¿t action cá»§a cÃ¡c process khÃ¡c.



