```table-of-contents
```
# Working around the GIL

The ***Global interpreter lock (GIL)*** ƒë√¥i khi l·∫°i l√† m·ªôt c∆° ch·∫ø l√†m gi·∫£m hi·ªáu nƒÉng khi th·ª±c hi·ªán c√°c t√°c v·ª• y√™u c·∫ßu s·ª©c m·∫°nh c·ªßa CPU.

GIL trong Python CPython ch·ªâ cho ph√©p **m·ªôt thread th·ª±c thi bytecode t·∫°i m·ªôt th·ªùi ƒëi·ªÉm**, d√π b·∫°n c√≥ nhi·ªÅu CPU.

Vi·ªác s·ª≠ d·ª•ng ***multiprocessing*** gi√∫p bypass h·∫°n ch·∫ø n√†y b·∫±ng vi·ªác ***t·∫°o ra nhi·ªÅu process*** thay v√¨ nhi·ªÅu thread, ***m·ªói process l·∫°i c√≥ GIL ri√™ng*** ‚áí Kh√¥ng b·ªã r√†ng bu·ªôc b·ªüi GIL c·ªßa process kh√°c.

Trong python, m·ªói process ch·∫°y **m·ªôt b·∫£n ri√™ng bi·ªát c·ªßa Python interpreter** (c√≥ th·ªÉ hi·ªÉu l√† m·ªôt ch∆∞∆°ng tr√¨nh Python ƒë·ªôc l·∫≠p).
- M·ªói Python interpreter c√≥ **GIL ri√™ng c·ªßa n√≥**.
- GIL l√† c∆° ch·∫ø n·ªôi b·ªô c·ªßa Python (CPython) ƒë·ªÉ ƒë·∫£m b·∫£o r·∫±ng ch·ªâ c√≥ **m·ªôt thread** ch·∫°y Python bytecode t·∫°i m·ªôt th·ªùi ƒëi·ªÉm trong m·ªôt process.
- Nh∆∞ng v√¨ b√¢y gi·ªù m·ªói process l√† m·ªôt interpreter ri√™ng, ch√∫ng **kh√¥ng b·ªã r√†ng bu·ªôc b·ªüi GIL chung** n·ªØa.

## Utilizing sub-processes

Trong Python, c√≥ th·ªÉ t·∫°o ra nhi·ªÅu process, m·ªói process ch·∫°y tr√™n c√°c core kh√°c nhau c·ªßa CPU.

C√°c process n√†y ch·∫°y ***song song th·∫≠t s·ª±*** ch·ª© ko ph·∫£i concurrent switching nh∆∞ Thread

```python
import multiprocessing
def myProcessFunc():
    print("Currently Executing Child Process")
    print("This process has it's own instance of the GIL")
    print("Executing Main Process")
    print("Creating Child Process")

if __name__ == '__main__':
    myProcess = multiprocessing.Process(target=myProcessFunc)
    myProcess.start()
    myProcess.join()
    print("Child Process has terminated, terminating main process")
```

- B·∫Øt bu·ªôc ph·∫£i ƒë·ªÉ c√°c **code multiprocessing trong `if __name__ == "__main__"`**, ƒëi·ªÅu n√†y **b·∫Øt bu·ªôc tr√™n Windows** v√¨ Windows s·ª≠ d·ª•ng `spawn` ƒë·ªÉ t·∫°o process m·ªõi thay v√¨ `fork`
- khi Python c·ªë g·∫Øng t·∫°o process m·ªõi, n√≥ l·∫°i ch·∫°y l·∫°i to√†n b·ªô file `.py` ‚Äî v√† v√¨ kh√¥ng c√≥ `if __name__ == "__main__"` n√™n **n√≥ ch·∫°y lu√¥n c·∫£ `myProcess.start()` trong process con**, g√¢y ra v√≤ng l·∫∑p v√¥ h·∫°n ho·∫∑c l·ªói kh·ªüi t·∫°o.

## The life of a process

C√≥ 3 c√°ch ƒë·ªÉ kh·ªüi ch·∫°y m·ªôt process m·ªõi trong Python:
* ***Spawn***
* ***Fork***
* ***Forkserver***

### ***Starting a process using fork***

***Forking*** l√† m·ªôt c∆° ch·∫ø ***ƒë∆∞·ª£c s·ª≠ d·ª•ng trong Unix system ƒë·ªÉ t·∫°o ra c√°c child processes t·ª´ parent process***.
* C√°c child process gi·ªëng h·ªát c√°c parent process, c√≥ c√πng m√£ ngu·ªìn, c√πng tr·∫°ng th√°i bi·∫øn to√†n c·ª•c (t·∫°i th·ªùi ƒëi·ªÉm fork/spawn), v√† m√¥i tr∆∞·ªùng th·ª±c thi t∆∞∆°ng t·ª±.
* C√°c child process v·∫´n c√≥ b·ªô nh·ªõ ri√™ng bi·ªát v√† ho·∫°t ƒë·ªông ƒë·ªôc l·∫≠p ‚Üí kh√¥ng chia s·∫ª tr·ª±c ti·∫øp bi·∫øn, b·ªô nh·ªõ nh∆∞ thread.
* C·∫ßn c∆° ch·∫ø nh∆∞ queue/pipe ƒë·ªÉ trao ƒë·ªïi d·ªØ li·ªáu

<span style="color: red">ƒê√¢y l√† c∆° ch·∫ø t·∫°o process m·∫∑c ƒë·ªãnh trong Unix</span>

---

### ***Spawing a process***

Khi ***spawn*** m·ªôt process, n√≥ ***kh√¥ng sao ch√©p to√†n b·ªô process cha*** nh∆∞ Unix `fork()` m√† ch·ªâ nh·∫≠n nh·ªØng g√¨ c·∫ßn ƒë·ªÉ th·ª±c thi.

‚û°Ô∏è vi·ªác kh·ªüi t·∫°o process nh·∫π nh√†ng h∆°n nh∆∞ng c·∫ßn tu√¢n th·ªß `if __name__ == "__main__` ƒë·ªÉ kh·ªüi t·∫°o m·ªôt parent process.

<span style="color: red">ƒê√¢y l√† c∆° ch·∫ø t·∫°o process m·∫∑c ƒë·ªãnh tr√™n Window</span>

---
### ***So s√°nh fork v√† spawn (ƒë·ªçc th√™m ƒë·ªÉ nh·ªõ)***

<span style="color: red; font-weight: bold">Tr√™n Unix/Linux: s·ª≠ d·ª•ng fork()</span>
* Khi m·ªôt process m·ªõi ƒë∆∞·ª£c t·∫°o
	* OS d√πng `fork()`: t·∫°o ra ***b·∫£n sao ƒë·∫ßy ƒë·ªß c·ªßa process cha*** (bao g·ªìm v√πng nh·ªõ, bi·∫øn to√†n c·ª•c, tr·∫°ng th√°i,...)
	* Sau ƒë√≥, ti·∫øn tr√¨nh con c√≥ th·ªÉ ***ch·∫°y ti·∫øp t·ª´ c√πng d√≤ng code*** trong m√£ ngu·ªìn gi·ªëng nh∆∞ ti·∫øn tr√¨nh cha.
* <span style="color: green">∆Øu ƒëi·ªÉm</span>:
	* Ko c·∫ßn lo·∫°i l·∫°i to√†n b·ªô file m√£ ngu·ªìn v√†o b·ªô nh·ªõ.
	* D·ªÖ d√†ng chia s·∫ª tr·∫°ng th√°i ban ƒë·∫ßu (v√≠ d·ª•: c√°c bi·∫øn global ƒë∆∞·ª£c copy)
‚û°Ô∏è `multiprocesscing` tr√™n Unix ***ƒë∆°n gi·∫£n h∆°n v√† nhanh h∆°n*** (v√¨ ko c·∫ßn reload ch∆∞∆°ng tr√¨nh)

<span style="color: red; font-weight: bold">Tr√™n Window: s·ª≠ d·ª•ng spawn()</span>
* Window ***kh√¥ng h·ªó tr·ª£ fork()***, n√™n Python ph·∫£i d√πng `spawn()`
	* ***T·∫°o m·ªôt ti·∫øn tr√¨nh m·ªõi t·ª´ ƒë·∫ßu***, gi·ªëng nh∆∞ ch·∫°y m·ªôt file python ri√™ng
	* ***Ch·ªâ truy·ªÅn v√†o t√™n h√†m***, ƒë·ªëi s·ªë v√†  v√†i c·∫•u h√¨nh c·∫ßn thi·∫øt ƒë·ªÉ ***ti·∫øn tr√¨nh con t·ª± ƒë·ªông kh·ªüi ch·∫°y t·ª´ ƒë·∫ßu***.
* Do kh·ªüi ch·∫°y m·ªôt ti·∫øn tr√¨nh t·ª´ ƒë·∫ßu
	* Python ph·∫£i ***n·∫°p l·∫°i m√£ ngu·ªìn .py***  v√† ch·∫°y l·∫°i t·ª´ ƒë·∫ßu trong ti·∫øn tr√¨nh con.
	* N·∫øu trong m√£ ngu·ªìn kh√¥ng c√≥ `if __name__ == "__main__"` ‚áí python s·∫Ω ch·∫°y c·∫£ ph·∫ßn t·∫°o process l·∫∑p l·∫°i trong process con ‚áí g√¢y loop v√¥ h·∫°n, t·∫°o ra l·ªói

#### ***Gi·∫£i th√≠ch v·ªÅ spawn trong window***

Trong m·ªói file Python, **bi·∫øn ƒë·∫∑c bi·ªát `__name__`** s·∫Ω ƒë∆∞·ª£c t·ª± ƒë·ªông t·∫°o ra b·ªüi tr√¨nh th√¥ng d·ªãch Python.
- N·∫øu file ƒëang **ƒë∆∞·ª£c ch·∫°y tr·ª±c ti·∫øp** (b·∫±ng l·ªánh `python file.py`), th√¨:
```python
__name__ == "__main__"
```
- N·∫øu file ƒëang **b·ªã import t·ª´ file kh√°c** (v√≠ d·ª• nh∆∞ `import mymodule`), th√¨:
```python
__name__ == "mymodule"  # t·ª©c l√† t√™n c·ªßa file ƒë√≥ (kh√¥ng c√≥ ƒëu√¥i .py)
```

<span style="color: orange">Do ƒë√≥, n·∫øu kh√¥ng c√≥ </span> `if __name__ == "__main__"`, khi ti·∫øn tr√¨nh con ch·∫°y l·∫°i m√£ ngu·ªìn, n√≥ ti·∫øp t·ª•c ƒë·ªçc l·∫°i ƒëo·∫°n kh·ªüi t·∫°o ti·∫øn tr√¨nh con ‚û°Ô∏è t·∫°o ra ti·∫øn tr√¨nh ch√°u ü•≤ü•≤ v√† loop nh∆∞ th·∫ø kh√¥ng ng·ª´ng.

<span style="color: orange">N·∫øu c√≥ </span> `if __name__ == "__main__"`:
* Python **reload l·∫°i file g·ªëc** (do c∆° ch·∫ø `spawn` tr√™n Windows), **nh∆∞ng KH√îNG ch·∫°y ƒëo·∫°n `if __name__ == "__main__"`** v√¨:
```python
__name__ != "__main__"`  # n√≥ l√† __mp_main__ ho·∫∑c t√™n module kh√°c
```
* ‚û°Ô∏è **Ch·ªâ ch·∫°y nh·ªØng g√¨ n√≥ c·∫ßn ƒë·ªÉ th·ª±c thi `target=function` m√† b·∫°n ƒë√£ truy·ªÅn v√†o.** V√≠ d·ª•:
```python
p = multiprocessing.Process(target=do_work)
p.start()
```
‚û°Ô∏è Trong process con, Python **ch·ªâ g·ªçi `do_work()`**, kh√¥ng t·∫°o th√™m process m·ªõi, kh√¥ng ch·∫°y l·∫°i main code.

---
## ***Forkserver***

***Forkserver*** l√† m·ªôt c√°ch √≠t ph·ªï bi·∫øn ƒë·ªÉ t·∫°o ra process m·ªõi, OS s·∫Ω kh√¥ng tr·ª±c ti·∫øp `fork()` nh∆∞ b√¨nh th∆∞·ªùng m√† th√¥ng qua m·ªôt ***server trung gian***
C√°ch `fork()` n√†y y√™u c·∫ßu OS h·ªó tr·ª£ `Unix Domain Sockets ho·∫∑c Pipes`, c√≥ kh·∫£ nƒÉng truy·ªÅn ***file descriptors*** gi·ªØa c√°c process ‚áíCh·ªâ √°p d·ª•ng v·ªõi Linux ho·∫∑c macOS

***C√°c b∆∞·ªõc t·∫°o process***
Khi ch·ªçn `forkserver` l√†m start method, Python s·∫Ω:
* ***Kh·ªüi ƒë·ªông m·ªôt "fork server process"*** ri√™ng bi·ªát ngay khi ch∆∞∆°ng tr√¨nh b·∫Øt ƒë·∫ßu
* Sau ƒë√≥, m·ªói l·∫ßn g·ªçi `multiprocessing.Process()`, thay v√¨ g·ªçi `fork()` tr·ª±c ti·∫øp, ch∆∞∆°ng tr√¨nh s·∫Ω: 
	* ***G·ª≠i request ƒë·∫øn fork server.***
	* Fork server s·∫Ω ***t·∫°o process m·ªõi, tr·∫£ v·ªÅ cho main process handle t·ªõi process m·ªõi***

‚ö†Ô∏è <span style="color: orange; font-weight: bold; font-style: italic">Ch√∫ √Ω </span>:
Child process do `forkserver` sinh ra, kh√¥ng ph·∫£i `main process` sinh ra
‚áí parent PID c·ªßa child process ch√≠nh l√† PID c·ªßa `forkserver`


 üìå ***V√¨ sao d√πng forkserver?***

| L√Ω do d√πng `forkserver`                                  | Gi·∫£i th√≠ch                                                                                                                   |
| -------------------------------------------------------- | ---------------------------------------------------------------------------------------------------------------------------- |
| ‚úÖ **Tr√°nh l·ªói khi forking sau khi import th∆∞ vi·ªán n·∫∑ng** | M·ªôt s·ªë th∆∞ vi·ªán nh∆∞ TensorFlow, NumPy c√≥ th·ªÉ g·∫∑p l·ªói khi b·∫°n `fork()` sau khi ƒë√£ load C extension. Forkserver tr√°nh l·ªói n√†y. |
| ‚úÖ **An to√†n h∆°n trong m√¥i tr∆∞·ªùng multi-threaded**        | Fork trong thread kh√°c main thread c√≥ th·ªÉ g√¢y treo ho·∫∑c undefined behavior.                                                  |
| ‚ùå **Kh√¥ng d√πng ƒë∆∞·ª£c tr√™n Windows**                       | Do Windows kh√¥ng c√≥ `fork()` v√† kh√¥ng truy·ªÅn ƒë∆∞·ª£c file descriptor qua socket nh∆∞ Unix.                                       |

V√≠ d·ª•:

```python
import multiprocessing
import os
import time

def worker():
    print(f"[Child PID: {os.getpid()}] Parent PID (PPID): {os.getppid()}")
    time.sleep(1)

def main():
    print(f"[Main PID: {os.getpid()}] Starting main process")

    # Ch·ªçn start method l√† forkserver (ch·ªâ ch·∫°y tr√™n Unix)
    multiprocessing.set_start_method("forkserver", force=True)

    processes = []
    for i in range(3):
        p = multiprocessing.Process(target=worker)
        p.start()
        processes.append(p)

    for p in processes:
        p.join()

    print(f"[Main PID: {os.getpid()}] All child processes finished.")

if __name__ == "__main__":
    main()
```

‚ö†Ô∏è‚ö†Ô∏è ***Trong v√≠ d·ª• tr√™n ta th·∫•y***:
* `PPID` c·ªßa c√°c child process l√† `PID` c·ªßa `forkserver`, kh√¥ng ph·∫£i `PID` c·ªßa `main process`

---

## ***Daemon processes***

T∆∞∆°ng t·ª± nh∆∞ `daemon threads`, `daemon processes` c≈©ng ch·∫°y trong n·ªÅn background, v√† ch·ªâ b·ªã kill khi `main thread` b·ªã kill.

```python
import multiprocessing
import time

def daemonProcess():
    print("Starting my Daemon Process")
    print("Daemon process started:{}".format(multiprocessing.current_process()))
    time.sleep(3)
    print("Daemon process terminating")
    print("Main process: {}".format(multiprocessing.current_process()))

if __name__ == "__main__":
    myProcess = multiprocessing.Process(target=daemonProcess)
    myProcess.daemon = True
    myProcess.start()
    print("We can carry on as per usual and our daemon will continue to execute")
    time.sleep(11)
```

---
## ***C√°c method th∆∞·ªùng s·ª≠ d·ª•ng v·ªõi processes***

### L·∫•y PID, name c·ªßa process

```python
import multiprocessing
print(multiprocessing.current_process().pid)
```

```python
import multiprocessing
import time

def childTask():
    print("Child Process With PID: {}".format(multiprocessing.current_process().pid))
    print("{} Just performed X".format(multiprocessing.current_process().name))
    time.sleep(3)
    print("Child process terminating")

def main():
    print("Main process PID: {}".format(multiprocessing.current_process().pid))
    myProcess = multiprocessing.Process(target=childTask, name="My-child-process")
    myProcess.start()
    myProcess.join()
if __name__ == '__main__':
    main()
```

### Terminating a process

ƒê·ªÉ terminate c√°c process trong python, s·ª≠ d·ª•ng h√†m sau:
```python
myProcess.terminate()
```

```python
import multiprocessing
import time

def myProcessFunc():
    current_process = multiprocessing.current_process()
    print("Child Process PID: {}".format(current_process.pid))
    time.sleep(20)
    current_process = multiprocessing.current_process()
    print("Main process PID: {}".format(current_process.pid))

if __name__ == "__main__":
    myProcess = multiprocessing.Process(target=myProcessFunc)
    myProcess.start()
    print("My Process has terminated, terminating main thread")
    print("Terminating Child Process")
    myProcess.terminate()
    print("Child Process Successfully terminated")
```

### Getting current process

```python
import multiprocessing
print(multiprocessing.current_process().pid)
```

### Subclassing processes

T∆∞∆°ng t·ª± nh∆∞ thread, ch√∫ng ta c≈©ng c√≥ th·ªÉ t·∫°o ra c√°c process b·∫±ng c√°ch k·∫ø th·ª´a class `multiprocessing.Process`.
Ch√∫ √Ω: trong h√†m constructor, c·∫ßn ph·∫£i call t·ªõi constructor c·ªßa class cha `multiprocessing.Process`

```python
import multiprocessing

class MyProcess(multiprocessing.Process):
	def __init__(self):
		super(MyProcess, self).__init__()

	def run(self):
		print("Child process PID: {}".format(multiprocessing.current_process().pid))

def main():
	print("Main Process PID: {}".format(multiprocessing.current_process().pid))
	myProcess = MyProcess()
	myProcess.start()
	myProcess.join()

if __name__ == '__main__':
	main()
```

# Multiprocessing pools

Khi c·∫ßn s·ª≠ d·ª•ng ***nhi·ªÅu ti·∫øn tr√¨nh*** ƒë·ªÉ th·ª±c hi·ªán c√°c t√°c v·ª• song song, Python cung c·∫•p m·ªôt c√¥ng c·ª• c√≥ t√™n l√† `Pool`, n·∫±m trong module `multiprocessing`.
`Pool` gi√∫p ***qu·∫£n l√Ω v√† ƒëi·ªÅu ph·ªëi nhi·ªÅu ti·∫øn tr√¨nh con m·ªôt c√°ch d·ªÖ d√†ng***, thay v√¨ ph·∫£i t·∫°o t·ª´ng ti·∫øn tr√¨nh th·ªß c√¥ng b·∫±ng `Process`.

V·ªõi `Pool` c√≥ th·ªÉ ***kh·ªüi ch·∫°y m·ªôt nh√≥m c√°c child process*** m·ªôt c√°ch nhanh ch√≥ng. Sau ƒë√≥, c√≥ th·ªÉ g·ª≠i c√°c `task` v√†o pool v√† c√°c ti·∫øn tr√¨nh con s·∫Ω  ***t·ª± ƒë·ªông l·∫•y c√°c task ra ƒë·ªÉ x·ª≠ l√Ω***.

```python
import multiprocessing

def square(n):
    print("Executed by process {}".format(multiprocessing.current_process().pid))
    return n * n

if __name__ == "__main__":
    numbers = [1, 2, 3, 4, 5]
    
    # T·∫°o m·ªôt pool v·ªõi 4 ti·∫øn tr√¨nh
    with multiprocessing.Pool(processes=4) as pool:
        # map: √°p d·ª•ng h√†m square cho t·ª´ng ph·∫ßn t·ª≠ trong numbers (song song)
        results = pool.map(square, numbers)
    
    print("Input:", numbers)
    print("Squared:", results)
```

## S·ª± kh√°c nhau gi·ªØa Pool v√† concurrent.futures.ProcessPoolExecutor

`multiprocess.Pool` v√† `concurrent.futures.ProcessPoolExecutor` ƒë·ªÅu cung c·∫•p ch·ª©c nƒÉng x·ª≠ l√Ω song song b·∫±ng nhi·ªÅu process.
Tuy nhi√™n:
* `concurrent.futures` gi√∫p ƒë∆°n gi·∫£n h√≥a `interface` khi c√≥ th·ªÉ l√†m vi·ªác tr√™n c·∫£ `thread pool` v√† `process pool` ‚û°Ô∏è gi√∫p coder d·ªÖ ti·∫øp c·∫≠n
* Do ·ªü m·ª©c high-level n√™n `concurrent.futures.ProcessPoolExecutor` kh√¥ng th·ªÉ ***ƒëi·ªÅu khi·ªÉn chi ti·∫øt (fine-grained control)*** nh∆∞ khi s·ª≠ d·ª•ng `multiprocess.Pool`:
	* Kh√¥ng t√πy ch·ªânh ƒë∆∞·ª£c c√°ch spawn process
	* Kh√¥ng thao t√°c s√¢u v·ªõi c√°c pipe, queue ho·∫∑c worker
‚ö†Ô∏è V·ªõi `concurrent.futures.ProcessPoolExecutor`, n√≥ lu√¥n lu√¥n t·∫°o ra process m·ªõi b·∫±ng `spawn`


<span style="color: orange; font-weight: bold; font-style: italic">T√πy ch·ªânh c√°ch spawn process</span>
* Trong `multiprocessing`, c√≥ th·ªÉ c·∫•u h√¨nh ch·ªçn ***c√°ch ti·∫øn tr√¨nh ƒë∆∞·ª£c sinh ra*** th√¥ng qua `multiprocessing.set_start_method()`, bao g·ªìm 3 c√°ch t·∫°o child process ƒë√£ n√≥i ·ªü tr√™n:
	* `'fork'`
	* `'spawn'`
	* `'forkserver'`

```python
import multiprocessing

def show_method():
    print(f"Start method: {multiprocessing.get_start_method()}")

if __name__ == '__main__':
    multiprocessing.set_start_method('fork')  # Ch·ªâ Linux m·ªõi d√πng ƒë∆∞·ª£c 'fork'
    p = multiprocessing.Process(target=show_method)
    p.start()
    p.join()

```
	

<span style="color: orange; font-weight: bold; font-style: italic">C√°c thao t√°c v·ªõi pipe, queue ho·∫∑c worker</span>
`multiprocessing` h·ªó tr·ª£ c√°c ***primitive ƒë·ªÉ giao ti·∫øp gi·ªØa c√°c ti·∫øn tr√¨nh*** nh∆∞:
* `multiprocessing.Queue`: h√†ng ƒë·ª£i d·ªØ li·ªáu gi·ªØa c√°c process
* `multiprocessing.Pipe`: k·∫øt n·ªëi 2 chi·ªÅu gi·ªØa 2 process

```python
import multiprocessing

def worker(queue):
    queue.put("Hello from child")

if __name__ == '__main__':
    q = multiprocessing.Queue()
    p = multiprocessing.Process(target=worker, args=(q,))
    p.start()
    print(q.get())  # ƒê·ªçc d·ªØ li·ªáu t·ª´ ti·∫øn tr√¨nh con
    p.join()
```

`ProcessPoolExecutor` kh√¥ng cho truy·ªÅn tr·ª±c ti·∫øp queue v√†o child process.


***N√™n s·ª≠ d·ª•ng concurrent.futures trong h·∫ßu h·∫øt c√°c t√¨nh hu·ªëng v√¨***:
1. D·ªÖ d√πng h∆°n, API th·ªëng nh·∫•t
2. ƒê·ªß c√°c t√≠nh nƒÉng ph·ª•c cho cho ƒëa s·ªë nhu c·∫ßu th·ª±c t·∫ø
3. D·ªÖ b·∫£o tr√¨, d·ªÖ ƒë·ªçc code

***Tuy nhi√™n khi c·∫ßn custom s√¢u h∆°n, ho·∫∑c c√°c t√≠nh nƒÉng m√† concurrent kh√¥ng h·ªó tr·ª£ th√¨ n√™n d√πng multiprocessing.Pool***
1. Mu·ªën t√πy ch·ªânh c√°ch t·∫°o ra child process
2. Truy·ªÅn Queue, Pipe gi·ªØa c√°c process
3. Ki·ªÉm so√°t chi ti·∫øt c√°c worker
4. Giao ti·∫øp ph·ª©c t·∫°p gi·ªØa c√°c process

## Context manager

T·∫°o context manager v·ªõi `multiprocessing.Pool` t∆∞∆°ng t·ª± nh∆∞ v·ªõi `ThreadPoolExecutors`
```python
from multiprocessing import Pool
with Pool(4) as myPool:
	pass
```

```python
from multiprocessing import Pool

def task(n):
	print(n)
	
def main():
	with Pool(4) as p:
		print(p.map(task, [2,3,4]))

if __name__ == '__main__':
	main()
```

### Apply_async

H√†m `apply_async()` ƒë∆∞·ª£c s·ª≠ d·ª•ng ƒë·ªÉ:
- G·ª≠i task v√†o pool ƒë·ªÉ x·ª≠ l√Ω b·∫•t ƒë·ªìng b·ªô (asynchronously)
- Kh√¥ng ch·ªù task ho√†n th√†nh ngay l·∫≠p t·ª©c (n√≥ ch·∫°y n·ªÅn)
- Tr·∫£ v·ªÅ m·ªôt `AsyncResult` ‚Äî ƒë·ªëi t∆∞·ª£ng n√†y gi√∫p b·∫°n **l·∫•y k·∫øt qu·∫£ sau** khi task ho√†n t·∫•t.

```python
from multiprocessing import Pool
import time
import os

def myTask(n):
    time.sleep(n)
    print("Task processed by Process {}".format(os.getpid()))
    return n*2

def main():
    print("apply_async")
    with Pool(4) as p:
        tasks = []
        for i in range(4):
            task = p.apply_async(func=myTask, args=(i,))
            tasks.append(task)
        for task in tasks:
            task.wait()
            print("Result: {}".format(task.get()))
        return "Done"
if __name__ == '__main__':
    print(main())
```

## Maxtasksperchild

Trong nhi·ªÅu h·ªá th·ªëng nh∆∞ `apache`, ho·∫∑c `mod_wsgi` (ch·∫°y python trong webserver), c√≥ m·ªôt c∆° ch·∫ø ƒë·ªÉ:
* Sau khi ti·∫øn tr√¨nh con ph·ª•c v·ª• m·ªôt s·ªë request nh·∫•t ƒë·ªãnh, n√≥ s·∫Ω ƒë∆∞·ª£c t√°i ch·∫ø l·∫°i `recycle`
* M·ª•c ƒë√≠ch: gi·∫£i ph√≥ng b·ªô nh·ªõ, d·ªçn r√°c, tr√°nh memory leak, gi·ªØ hi·ªáu nƒÉng ·ªïn ƒë·ªãnh
‚úÖ`maxtasksperchild` trong `multiprocessing.Pool` gi√∫p ch·ªâ ƒë·ªãnh ***s·ªë l∆∞·ª£ng task ƒë·ªëi ƒëa*** m√† m·ªôt ti·∫øn tr√¨nh con ƒë∆∞·ª£c ph√©p x·ª≠ l√Ω, tr∆∞·ªõc khi ***t·ª± ƒë·ªông terminate v√† ƒë∆∞·ª£c t·∫°o l·∫°i*** trong pool.

```python 
Pool(processes=4, maxtasksperchild=5)
```
* M·ªói process con ***ch·ªâ x·ª≠ l√Ω t·ªëi ƒëa 5 task***
* Sau khi x·ª≠ l√Ω xong 5 task, process ƒë√≥ s·∫Ω b·ªã ***kill*** v√† ***Pool t·ª± spawn ti·∫øn tr√¨nh m·ªõi ƒë·ªÉ thay th·∫ø***
```python
from multiprocessing import Pool
import os
import time

def task(n):
    print(f"Process {os.getpid()} handling task {n}")
    time.sleep(0.5)
    return n * n

if __name__ == '__main__':
    with Pool(processes=2, maxtasksperchild=3) as pool:
        results = pool.map(task, range(10))

    print("Results:", results)

```