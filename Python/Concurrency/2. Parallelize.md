```table-of-contents
```

# Understanding Concurrency

Báº£n cháº¥t cá»§a concurrency lÃ  ***má»™t ngÆ°á»i*** lÃ m ***nhiá»u viá»‡c, vÃ  chuyá»ƒn qua láº¡i ráº¥t nhanh giá»¯a cÃ¡c cÃ´ng viá»‡c***.

## Äiá»ƒm ngháº½n hiá»‡u nÄƒng giá»¯a hai mÃ´ hÃ¬nh

***Vá»›i concurrency***

 ğŸ‘‰ Náº¿u báº¡n **Ã¡p dá»¥ng concurrency (Ä‘á»“ng thá»i hÃ³a)** cho má»™t Ä‘iá»ƒm ngháº½n do **CPU** gÃ¢y ra (vÃ­ dá»¥, tÃ­nh toÃ¡n náº·ng), thÃ¬ thay vÃ¬ cáº£i thiá»‡n hiá»‡u nÄƒng, **hiá»‡u nÄƒng cÃ³ thá»ƒ giáº£m Ä‘i**.  
âš ï¸ VÃ¬ concurrency thÆ°á»ng dÃ¹ng cho cÃ¡c tÃ¡c vá»¥ **I/O-bound** (nhÆ° chá» Ä‘á»c file, truy cáº­p máº¡ng), khÃ´ng giÃºp Ã­ch gÃ¬ nhiá»u khi CPU Ä‘ang lÃ  Ä‘iá»ƒm ngháº½n.

***Vá»›i parallelism***

ğŸ‘‰ NgÆ°á»£c láº¡i, náº¿u báº¡n **dÃ¹ng parallelism (xá»­ lÃ½ song song)** cho má»™t tÃ¡c vá»¥ mÃ  **cáº§n concurrency** (vÃ­ dá»¥ nhÆ° xá»­ lÃ½ nhiá»u káº¿t ná»‘i máº¡ng khÃ´ng Ä‘á»“ng bá»™), thÃ¬ hiá»‡u nÄƒng cÅ©ng **cÃ³ thá»ƒ bá»‹ giáº£m**.  
âš ï¸ VÃ¬ parallelism thÆ°á»ng yÃªu cáº§u chia nhá» tÃ¡c vá»¥ vÃ  xá»­ lÃ½ Ä‘á»“ng thá»i báº±ng nhiá»u lÃµi CPU, nhÆ°ng láº¡i khÃ´ng hiá»‡u quáº£ vá»›i tÃ¡c vá»¥ chá»§ yáº¿u lÃ  I/O.

## Má»™t sá»‘ tÃ­nh cháº¥t cá»§a concurrent systems

* ***Multiple actors*** : cáº£ processes vÃ  threads Ä‘á»u lÃ  cÃ¡c actors Ä‘á»™c láº­p, má»—i actor sáº½ xá»­ lÃ½ cÃ´ng viá»‡c riÃªng cá»§a nÃ³. Má»™t chÆ°Æ¡ng trÃ¬nh cÃ³ nhiá»u processes, má»™t process láº¡i cÃ³ nhiá»u threads.
* ***Shared resources***: cÃ¡c actors khÃ´ng hoáº¡t Ä‘á»™ng Ä‘á»™c láº­p hoÃ n toÃ n, chÃºng chia sáº» cÃ¡c tÃ i nguyÃªn nhÆ°: RAM, Disk, I/O device, ..... ChÃ­nh vÃ¬ cÃ¡c tÃ i nguyÃªn Ä‘Æ°á»£c shared â¡ï¸ cÃ³ nguy cÆ¡ xáº£y ra xung Ä‘á»™t.
* ***Rules***: CÃ³ má»™t sá»‘ cÃ¡c quy táº¯c Ä‘iá»u phá»‘i quyá»n truy cáº­p Ä‘á»ƒ trÃ¡nh lá»—i khi chia sáº» tÃ i nguyÃªn mÃ  táº¥t cáº£ cÃ¡c concurrent system pháº£i tuÃ¢n theo. CÃ¡c rule nÃ y sáº½ quy Ä‘á»‹nh, khi nÃ o má»™t actor cÃ³ thá»ƒ ***acquire*** vÃ  ***khÃ´ng thá»ƒ acquire*** lock, access memory, modify state,..... CÃ¡c quy táº¯c nÃ y Ä‘áº£m báº£o tÃ­nh nháº¥t quÃ¡n (consistency) cá»§a chÆ°Æ¡ng trÃ¬nh.

### I/O bottlenecks

***I/O bottleneck*** xáº£y ra khi mÃ¡y tÃ­nh giÃ nh quÃ¡ nhiá»u thá»i gian cho viá»‡c xá»­ lÃ½ input, output hÆ¡n lÃ  viá»‡c xá»­ lÃ½ logic chÆ°Æ¡ng trÃ¬nh.

Web browser lÃ  má»™t vÃ­ dá»¥ vá» heavy I/O apllication. NÃ³ dÃ nh pháº§n lá»›n thá»i gian Ä‘á»ƒ chá» network request. Náº¿u tá»‘c Ä‘á»™ mÃ  chÆ°Æ¡ng trÃ¬nh nháº­n Ä‘Æ°á»£c dá»¯ liá»‡u tá»« nguá»“n I/O ***cháº­m hÆ¡n*** tá»‘c Ä‘á»™ mÃ  chÆ°Æ¡ng trÃ¬nh xá»­ lÃ½ dá»¯ liá»‡u â¡ï¸ ***I/O bottleneck***.

Má»™t vÃ­ dá»¥ khÃ¡c vá» I/O bottleneck lÃ  web crawler.
```python
import urllib.request
import time
from bs4 import BeautifulSoup

t0 = time.time()
req = urllib.request.urlopen('http://www.example.com')
t1 = time.time()
print("Total Time To Fetch Page: {} Seconds".format(t1-t0))
soup = BeautifulSoup(req.read(), "html.parser")
for link in soup.find_all('a'):
print(link.get('href'))
t2 = time.time()
print("Total Execeution Time: {} Seconds".format)
```
Vá»›i vÃ­ dá»¥ trÃªn, pháº§n lá»›n thá»i gian chÆ°Æ¡ng trÃ¬nh dÃ¹ng Ä‘á»ƒ fetch dá»¯ liá»‡u. Náº¿u cáº§n crawl trÃªn nhiá»u trang web khÃ¡c nhau â¡ï¸ thá»i gian thá»±c thi quÃ¡ lÃ¢u.

<span style="font-size: 20px; font-weight:bold">Káº¿t luáº­n: </span> sá»­ dá»¥ng concurrency Ä‘á»ƒ xá»­ lÃ½ cÃ¡c bÃ i toÃ¡n vá» I/O bottlenecks

# Understanding parallelism

***Parallelism***: lÃ  viá»‡c thá»±c thi 2 hoáº·c nhiá»u cÃ´ng viá»‡c Ä‘á»“ng thá»i, trÃ¡i ngÆ°á»£c vá»›i concurrency. Parallelism sáº½ thá»±c sá»± xá»­ lÃ½ 2 task cÃ¹ng lÃºc (táº¡i cÃ¹ng má»™t thá»i Ä‘iá»ƒm), cÃ²n concurrency táº¡i má»™t thá»i Ä‘iá»ƒm chá»‰ thá»±c thi 1 task.

Äá»ƒ sá»­ dá»¥ng Ä‘Æ°á»£c parallelism, chÃºng ta cáº§n nhiá»u hÆ¡n 1 cpu core.
![[Pasted image 20250419231616.png]]
Trong thá»±c táº¿, má»™t vÃ­ dá»¥ Ä‘iá»ƒn hÃ¬nh cá»§a viá»‡c sá»­ dá»¥ng parallelism chÃ­nh lÃ  GPU cá»§a mÃ¡y tÃ­nh.

## CPU-bound bottlenecks

***CPU-bound bottleneck*** trÃ¡i ngÆ°á»£c hoÃ n toÃ n vá»›i ***I/O-bound bottleneck***, chÆ°Æ¡ng trÃ¬nh dÃ nh nhiá»u hiá»‡u nÄƒng cho cÃ¡c tÃ¡c vá»¥ tÃ­nh toÃ¡n => lÃ m cháº­m hiá»‡u nÄƒng.

CÃ¡c ***CPU-bound*** thÆ°á»ng xáº£y ra vá»›i cÃ¡c chÆ°Æ¡ng trÃ¬nh tÃ­nh toÃ¡n náº·ng nhÆ°: xá»­ lÃ½ áº£nh, há»c mÃ¡y, mÃ£ hÃ³a,....
Hiá»‡u nÄƒng cá»§a chÆ°Æ¡ng trÃ¬nh phá»¥ thuá»™c vÃ o tá»‘c Ä‘á»™ cá»§a CPU.

â¡ï¸ Cáº£i thiá»‡n hiá»‡u nÄƒng chÆ°Æ¡ng trÃ¬nh báº±ng viá»‡c dÃ¹ng nhiá»u CPU core cÃ¹ng lÃºc.

## Single-core CPUs

Single-core processor sáº½ chá»‰ thá»±c thi má»™t thread táº¡i má»™t thá»i Ä‘iá»ƒm.
Trong thá»i gian chá» (do I/O hoáº·c network), nÃ³ sáº½ thá»±c hiá»‡n viá»‡c switch giá»¯a cÃ¡c thread (***context switch***). 
Há»‡ thá»‘ng sáº½ lÆ°u láº¡i toÃ n bá»™ cÃ¡c thÃ´ng tin cá»§a thread cÅ© táº¡i thá»i Ä‘iá»ƒm Ä‘Ã³, switch sang thread má»›i Ä‘á»ƒ thá»±c thi. Sau Ä‘Ã³ qua láº¡i thread cÅ© sáº½ restore láº¡i toÃ n bá»™ dá»¯ liá»‡u Ä‘Ã£ lÆ°u Ä‘á»ƒ tiáº¿p tá»¥c thá»±c thi thread.

***ChÃº Ã½***: Khi sá»­ dá»¥ng multiple thread, chi phÃ­ tÃ­nh toÃ¡n Ä‘á»ƒ thá»±c hiá»‡n ***context switch*** lÃ  ráº¥t lá»›n, náº¿u khÃ´ng sá»­ dá»¥ng thread há»£p lÃ½ cÃ³ thá»ƒ lÃ m giáº£m hiá»‡u nÄƒng.

***Má»™t sá»‘ lá»£i Ã­ch cá»§a single-core CPUs***:
* KhÃ´ng yÃªu cáº§u giao thá»©c liÃªn láº¡c phá»©c táº¡o giá»¯a cÃ¡c multiple cores
* Sá»­ dá»¥ng single-core CPU tá»‘n Ã­t Ä‘iá»‡n nÄƒng hÆ¡n, phÃ¹ há»£p vá»›i cÃ¡c thiáº¿t vá»‹ IOT

***Má»™t sá»‘ báº¥t lá»£i khi sá»­ dá»¥ng single-core CPU***:
* ChÆ°Æ¡ng trÃ¬nh bá»‹ giá»›i háº¡n bá»Ÿi kháº£ nÄƒng cá»§a CPU, trong cÃ¡c á»©ng dá»¥ng lá»›n, phá»©c táº¡p cÃ³ thá»ƒ gÃ¢y treo há»‡ thá»‘ng.
* Náº¿u xá»­ lÃ½ tÃ¡c vá»¥ quÃ¡ náº·ng, CPU cÃ³ thá»ƒ bá»‹ quÃ¡ nÃ³ng vÃ  bá»‹ há»ng.

### Clock rate

Má»™t trong nhá»¯ng háº¡n cháº¿ cá»§a cÃ¡c single-core application Ä‘Ã³ lÃ  ***clock speed of the CPU - Sá»‘ clock cycles mÃ  CPU cÃ³ thá»ƒ thá»±c hiá»‡n má»—i giÃ¢y***.

Äá»‹nh luáº­t ***Moore*** dá»± Ä‘oÃ¡n ráº±ng, sá»‘ lÆ°á»£ng transitor trÃªn má»—i con chip tÄƒng gáº¥p Ä‘Ã´i sau má»—i 2 nÄƒm. Khi transitor nhá» hÆ¡n vÃ  nhiá»u hÆ¡n, CPU sáº½ cháº¡y nhanh hÆ¡n (***tÄƒng xung nhá»‹p - clock speed***).
Hiá»‡n nay, transitor Ä‘Ã£ thu nhá» Ä‘áº¿n má»©c vÃ i nanomet, gáº§n cháº¡m tá»›i giá»›i háº¡n váº­t lÃ½. Khi transitor quÃ¡ nhá» â¡ï¸ ***quantum tunneling*** - electron cÃ³ thá»ƒ ***xuyÃªn qua rÃ o cáº£n Ä‘iá»‡n*** mÃ  Ä‘ang láº½ nÃ³ ko Ä‘Æ°á»£c vÆ°á»£t qua â¡ï¸ transitor hoáº¡t Ä‘á»™ng khÃ´ng chÃ­nh xÃ¡c, gÃ¢y rÃ² Ä‘iá»‡n, lá»—i máº¡ch.

### Time-sharing - Task scheduler

***Task scheduler*** cÃ³ nhiá»‡m vá»¥ Ä‘áº£m báº£o má»—i task Ä‘á»u cÃ³ cÆ¡ há»™i thá»±c thi

VÃ­ dá»¥
```python
import threading
import time
import random
counter = 1
def workerA():
	global counter
	while counter < 1000:
		counter += 1
		print("Worker A is incrementing counter to {}".format(counter))
		sleepTime = random.randint(0,1)
		time.sleep(sleepTime)
def workerB():
	global counter
	while counter > -1000:
		counter -= 1
		print("Worker B is decrementing counter to {}".format(counter))
		sleepTime = random.randint(0,1)
		time.sleep(sleepTime)
def main():
	t0 = time.time()
	thread1 = threading.Thread(target=workerA)
	thread2 = threading.Thread(target=workerB)
	thread1.start()
	thread2.start()
	thread1.join()
	thread2.join()
	t1 = time.time()
	print("Execution Time {}".format(t1-t0))
if __name__ == '__main__':
	main()
```

Äoáº¡n code trÃªn cÃ³ thá»ƒ gÃ¢y ra ***infinite loop*** náº¿u CPU switch giá»¯a hai thread workerA vÃ  workerB â¡ï¸ Rá»§i ro khi dÃ¹ng chung dá»¯ liá»‡u.

## Multi-core processors

***Multi-core processors***: bao gá»“m cÃ¡c processing unit (core) hoáº¡t Ä‘á»™ng Ä‘á»™c láº­p.
Má»—i core sáº½ hoáº¡t Ä‘á»™ng theo vÃ²ng láº·p sau:
1. ***Fetch***: láº¥y cÃ¡c cÃ¢u lá»‡nh tá»« memory cá»§a chÆ°Æ¡ng trÃ¬nh. CÃ¡c cÃ¢u lá»‡nh nÃ y Ä‘Æ°á»£c xÃ¡c Ä‘á»‹nh bá»Ÿi `program counter (PC)` xÃ¡c Ä‘á»‹nh vá»‹ trÃ­ cá»§a bÆ°á»›c tiáº¿p theo cáº§n thá»±c hiá»‡n.
2. ***Decode***: Sau khi láº¥y Ä‘Æ°á»£c cÃ¡c instruction, core sáº½ convert nÃ³ sang signals Ä‘á»ƒ CPU cÃ³ thá»ƒ hiá»ƒu Ä‘Æ°á»£c
3. ***Execute***: CPU sáº½ thá»±c thi cÃ¡c Ä‘oáº¡n instruction láº¥y Ä‘Æ°á»£c. Káº¿t quáº£ cá»§a viá»‡c thá»±c thi Ä‘Æ°á»£c lÆ°u á»Ÿ cÃ¡c ***CPU register***.


# <span style="color: red">System architecture styles</span>

CÃ¡c ***System architecture styles*** khÃ¡c nhau sáº½ phÃ¹ há»£p vá»›i tá»«ng use case khÃ¡c nhau. Má»™t sá»‘ style sáº½ phÃ¹ há»£p vá»›i cÃ¡c computing task hoáº·c scientific computing, má»™t sá»‘ khÃ¡c thÃ¬ phÃ¹ há»£p vá»›i home-computing task

## SISD - single instruction stream, single data stream

Kiáº¿n trÃºc nÃ y bao gá»“m *1 luá»“ng datastream, 1 single unit Ä‘Æ°á»£c sá»­ dá»¥ng Ä‘á»ƒ xá»­ lÃ½ datastream Ä‘Ã³*.
![[Pasted image 20250420091628.png]]
ÄÃ¢y lÃ  style kiáº¿n trÃºc cá»§a Single-core processors

## SIMD - single instruction stream, mutiple data stream

Kiáº¿n trÃºc bao gá»“m *nhiá»u luá»“ng data stream, má»™t luá»“ng Instruction xá»­ lÃ½ toÃ n bá»™ cÃ¡c data nháº­n Ä‘Æ°á»£c***
VÃ­ dá»¥ trong xá»­ lÃ½ Ä‘á»“ há»a 3D, cÃ¡c dá»¯ liá»‡u Ä‘áº§u vÃ o lÃ  cÃ¡c vector nhiá»u chiá»u:
![[Pasted image 20250420092118.png]]

Kiáº¿n trÃºc nÃ y Ä‘Æ°á»£c Ã¡p dá»¥ng trong cÃ¡c lÃµi xá»­ lÃ½ Ä‘á»“ há»a, vÃ­ dá»¥ trong `OpenGL graphic programming`.
![[Pasted image 20250420092332.png]]
Trong vÃ­ dá»¥ trÃªn, cÃ³ nhiá»u luá»“ng data Ä‘áº¡i diá»‡n cho cÃ¡c vector nhiá»u chiá»u, Ä‘á»“ng thá»i cÃ³ nhiá»u cÃ¡c `processing units`.

Táº¥t cÃ¡c cÃ¡c `processing units` Ä‘á»u thá»±c thi chung má»™t `single instruction` â¡ï¸ ***xá»­ lÃ½ dá»¯ liá»‡u theo cÃ¹ng má»™t logic***.

***Lá»£i Ã­ch***:
* CÃ³ thá»ƒ thá»±c thi Ä‘á»“ng thá»i cÃ¹ng 1 logic trÃªn nhiá»u dá»¯ liá»‡u 
* Sá»©c máº¡nh tÃ­nh toÃ¡n sáº½ tÄƒng khi sá»‘ lÆ°á»£ng core cá»§a CPU tÄƒng.

## MISD - multiple instruction stream, single data stream

Kiáº¿n trÃºc nÃ y khÃ´ng Ä‘Æ°á»£c sá»­ dá»¥ng trong thá»±c táº¿

## MIMD - multiple instruction streams, multiple data streams

CÃ¡c core cá»§a CPU sáº½ cháº¡y song song vÃ  hoÃ n toÃ n Ä‘á»™c láº­p, vá»›i luá»“ng data input khÃ¡c nhau, xá»­ lÃ½ cÃ¡c táº­p lá»‡nh khÃ¡c nhau.
![[Pasted image 20250420093427.png]]


# <span style="color: red">Computer memory architecture styles</span>

Trong láº­p trÃ¬nh concurrency hoáº·c parallelism, viá»‡c tá»• chá»©c dá»¯ liá»‡u há»£p lÃ½ Ä‘á»ƒ cÃ¡c thread hoáº·c process cÃ³ thá»ƒ access data nhanh nháº¥t lÃ  biggest challenges.

Náº¿u viá»‡c access data khÃ´ng Ä‘á»§ nhanh â¡ï¸ dáº«n tá»›i ***bottleneck*** lÃ m giáº£m hiá»‡u nÄƒng chÆ°Æ¡ng trÃ¬nh.

## UMA - Uniform Memory Access

Vá»›i kiáº¿n trÃºc nÃ y, táº¥t cáº£ cÃ¡c core sáº½ sá»­ dá»¥ng chung má»™t ***memory space***.
***Má»i core Ä‘á»u truy cáº­p vÃ o bá»™ nhá»› chung vá»›i tá»‘c Ä‘á»™ nhÆ° nhau***, báº¥t ká»ƒ core Ä‘Ã³ cÃ³ náº±m gáº§n hay xa RAM thÃ¬ tá»‘c Ä‘á»™ truy cáº­p vÃ o bá»™ nhá»› RAM Ä‘á»u nhÆ° nhau.

![[Pasted image 20250420094831.png]]
Má»—i processor sáº½ Ä‘Æ°á»£c ***káº¿t ná»‘i vá»›i bus***. ***Bus*** lÃ  thÃ nh pháº§n trung gian chá»‹u trÃ¡ch nhiá»‡m truy cáº­p bá»™ nhá»› thay cho cÃ¡c CPU.
CPU muá»‘n Ä‘á»c/ghi Ä‘á»u pháº£i gá»­i qua ***Bus***.

***Æ¯u Ä‘iá»ƒm***:
* CÃ¡c CPU cÃ³ thá»ƒ truy cáº­p RAM vá»›i tá»‘c Ä‘á»™ nhÆ° nhau
* Äá»“ng nháº¥t dá»¯ liá»‡u
* Thiáº¿t káº¿ Ä‘Æ¡n giáº£n

***NhÆ°á»£c Ä‘iá»ƒm***: 
Khi cÃ³ nhiá»u CPU
*  Táº¥t cÃ¡c cÃ¡c CPU Ä‘á»u pháº£i dÃ¹ng chung má»™t bus
* GÃ¢y ra táº¯c ngháº½n Ä‘Æ°á»ng truyá»n khi táº¥t cÃ¡c CPU Ä‘á»u gá»­i request vÃ o bus â¡ï¸ Giáº£m hiá»‡u nÄƒng há»‡ thá»‘ng.

## NUMA - Non-uniform Memory Access

![[Pasted image 20250420105723.png]]
Vá»›i kiáº¿n trÃºc nÃ y, má»—i process sáº½ cÃ³ memory space riÃªng, I/O riÃªng, vÃ  sáº½ giao tiáº¿p vá»›i nhau qua ***interconnection network***.

***Lá»£i Ã­ch chÃ­nh cá»§a NUMA***:
* NUMA machine cÃ³ thá»ƒ dá»… dÃ ng scale hÆ¡n UMA

***Háº¡n cháº¿ cá»§a NUMA***:
* Tá»‘c Ä‘á»™ truy cáº­p vÃ o memory cá»§a CPU phá»¥ thuá»™c vÃ o vá»‹ trÃ­ cá»§a memory, náº¿u memory á»Ÿ local â‡’ truy cáº­p nhanh, náº¿u memory á»Ÿ xa â‡’ máº¥t thá»i gian Ä‘á»ƒ truy xuáº¥t memory.
* CÃ¡c processor pháº£i quan sÃ¡t sá»± thay Ä‘á»•i Ä‘Æ°á»£c táº¡o ra bá»Ÿi cÃ¡c processor khÃ¡c, thá»i gian dÃ nh cho viá»‡c nÃ y tÄƒng lÃªn khi sá»‘ lÆ°á»£ng processor tÄƒng.
